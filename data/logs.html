<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Logs - ESP32 KNX Thermostat</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .log-table th {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #34495e;
        }

        .log-table td {
            padding: 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        .log-table tr:hover {
            background-color: #f8f9fa;
        }

        .log-level {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .log-level-ERROR {
            background-color: #e74c3c;
            color: white;
        }

        .log-level-WARNING {
            background-color: #f39c12;
            color: white;
        }

        .log-level-INFO {
            background-color: #3498db;
            color: white;
        }

        .log-level-DEBUG {
            background-color: #95a5a6;
            color: white;
        }

        .log-level-VERBOSE {
            background-color: #bdc3c7;
            color: #2c3e50;
        }

        .log-timestamp {
            font-family: monospace;
            color: #7f8c8d;
        }

        .log-tag {
            font-family: monospace;
            font-weight: bold;
            color: #2c3e50;
        }

        .log-message {
            color: #2c3e50;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .filter-select {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .no-logs {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }

        .log-count {
            color: #7f8c8d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header>
        <h1>Event Logs</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2 class="card-title">System Event Logs</h2>

            <div class="controls">
                <button id="refresh-logs">Refresh</button>
                <button id="clear-logs" style="background-color: #e74c3c;">Clear All Logs</button>
                <select id="filter-level" class="filter-select">
                    <option value="all">All Levels</option>
                    <option value="ERROR">Errors Only</option>
                    <option value="WARNING">Warnings & Errors</option>
                    <option value="INFO">Info & Above</option>
                </select>
                <span class="log-count" id="log-count">0 entries</span>
            </div>

            <div id="logs-container">
                <table class="log-table" id="logs-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Level</th>
                            <th>Tag</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body">
                        <tr>
                            <td colspan="4" class="no-logs">Loading logs...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Navigation</h2>
            <div class="control-row">
                <a href="/"><button>Dashboard</button></a>
            </div>
            <div class="control-row">
                <a href="/config.html"><button>Configuration</button></a>
            </div>
        </div>
    </div>

    <script>
        let allLogs = [];

        // Fetch logs from the server
        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                if (!response.ok) {
                    throw new Error('Failed to fetch logs');
                }
                allLogs = await response.json();
                displayLogs();
            } catch (error) {
                console.error('Error fetching logs:', error);
                document.getElementById('logs-body').innerHTML =
                    '<tr><td colspan="4" class="no-logs">Error loading logs</td></tr>';
            }
        }

        // Display logs in the table
        function displayLogs() {
            const filterLevel = document.getElementById('filter-level').value;
            const tbody = document.getElementById('logs-body');

            // Filter logs based on selected level
            let filteredLogs = allLogs;
            if (filterLevel !== 'all') {
                const levelPriority = {
                    'ERROR': 1,
                    'WARNING': 2,
                    'INFO': 3,
                    'DEBUG': 4,
                    'VERBOSE': 5
                };
                const maxPriority = levelPriority[filterLevel] || 5;
                filteredLogs = allLogs.filter(log =>
                    (levelPriority[log.level] || 5) <= maxPriority
                );
            }

            // Update log count
            document.getElementById('log-count').textContent =
                `${filteredLogs.length} of ${allLogs.length} entries`;

            // Clear existing rows
            tbody.innerHTML = '';

            if (filteredLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-logs">No logs to display</td></tr>';
                return;
            }

            // Sort logs by timestamp (newest first)
            filteredLogs.sort((a, b) => b.timestamp - a.timestamp);

            // Add rows for each log entry
            filteredLogs.forEach(log => {
                const row = tbody.insertRow();

                // Timestamp column
                const timeCell = row.insertCell();
                timeCell.className = 'log-timestamp';
                timeCell.textContent = formatTimestamp(log.timestamp);

                // Level column
                const levelCell = row.insertCell();
                const levelSpan = document.createElement('span');
                levelSpan.className = `log-level log-level-${log.level}`;
                levelSpan.textContent = log.level;
                levelCell.appendChild(levelSpan);

                // Tag column
                const tagCell = row.insertCell();
                tagCell.className = 'log-tag';
                tagCell.textContent = log.tag;

                // Message column
                const msgCell = row.insertCell();
                msgCell.className = 'log-message';
                msgCell.textContent = log.message;
            });
        }

        // Format timestamp (milliseconds since boot) to readable format
        function formatTimestamp(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) {
                return `${days}d ${hours % 24}h ${minutes % 60}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Clear all logs
        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/logs/clear', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to clear logs');
                }

                allLogs = [];
                displayLogs();
                alert('Logs cleared successfully');
            } catch (error) {
                console.error('Error clearing logs:', error);
                alert('Failed to clear logs');
            }
        }

        // Event listeners
        document.getElementById('refresh-logs').addEventListener('click', fetchLogs);
        document.getElementById('clear-logs').addEventListener('click', clearLogs);
        document.getElementById('filter-level').addEventListener('change', displayLogs);

        // Load logs on page load
        fetchLogs();

        // Auto-refresh logs every 10 seconds
        setInterval(fetchLogs, 10000);
    </script>
</body>
</html>
