################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/index.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="description" content="Smart ESP32 KNX Thermostat with PID control">
  <meta name="theme-color" content="#1e88e5">

  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Thermostat">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <title>ESP32 KNX Thermostat</title>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
  <div id="app"></div>
  <script type="module" src="/src/main.jsx"></script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);

            // Check for updates periodically
            setInterval(() => {
              registration.update();
            }, 60000); // Check every minute
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/tailwind.config.js
################################################################################

/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  darkMode: 'class',
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#e3f2fd',
          100: '#bbdefb',
          200: '#90caf9',
          300: '#64b5f6',
          400: '#42a5f5',
          500: '#1e88e5', // Main primary color
          600: '#1976d2',
          700: '#1565c0',
          800: '#0d47a1',
          900: '#0a3d7a',
        },
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-in',
        'slide-in': 'slideIn 0.3s ease-out',
        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0', transform: 'scale(0.95)' },
          '100%': { opacity: '1', transform: 'scale(1)' },
        },
        slideIn: {
          '0%': { transform: 'translateX(100%)' },
          '100%': { transform: 'translateX(0)' },
        },
      },
    },
  },
  plugins: [],
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/vite.config.js
################################################################################

import { defineConfig } from 'vite';
import preact from '@preact/preset-vite';
import viteCompression from 'vite-plugin-compression';

export default defineConfig({
  plugins: [
    preact(),
    // Gzip compression for smaller file sizes
    viteCompression({
      algorithm: 'gzip',
      ext: '.gz',
      threshold: 1024, // Only compress files > 1KB
      deleteOriginFile: false,
    }),
  ],
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    minify: false, // Disable all minification - rely on gzip for size reduction
    rollupOptions: {
      output: {
        // Optimize chunk splitting for better caching
        // Use SHORT names to avoid LittleFS path length limit (~31 chars including .gz)
        // Format: /js/[name]-[hash].js.gz must be < 31 chars
        // So [name]-[hash] must be < 23 chars (8 chars for /js/.js.gz)
        manualChunks(id) {
          // Vendor chunks - shortened names
          if (id.includes('node_modules')) {
            if (id.includes('preact')) {
              return 'v-preact';  // Was 'vendor-preact' (13) -> now 7 chars
            }
            if (id.includes('uplot')) {
              return 'v-chart';   // Was 'vendor-chart' (12) -> now 6 chars
            }
            if (id.includes('headlessui') || id.includes('react-hot-toast')) {
              return 'v-ui';      // Was 'vendor-ui' (9) -> now 3 chars
            }
            // Split goober separately - it has circular dependency issues
            if (id.includes('goober')) {
              return 'v-css';     // Goober CSS-in-JS library
            }
            // Split zustand and use-sync-external-store separately to avoid circular deps
            if (id.includes('zustand') || id.includes('use-sync-external-store')) {
              return 'v-state';   // State management libraries
            }
            // Other node_modules go to vendor-misc
            return 'v-misc';      // Was 'vendor-misc' (11) -> now 5 chars
          }

          // Page-based chunking for lazy loading - shortened names
          if (id.includes('/pages/')) {
            const name = id.split('/pages/')[1].split('.')[0];
            // Merge tiny dashboard with status page to avoid sub-1KB files
            if (name === 'Dashboard') {
              return 'p-status';  // Merge with status page
            }
            // Use single letter prefix: p-config, p-dashboard, etc.
            return `p-${name.toLowerCase()}`;  // Was 'page-...' -> now 'p-...'
          }

          // Component chunks - shortened names
          if (id.includes('/components/Graph/')) {
            return 'c-graph';      // Was 'components-graph' (16) -> now 6 chars
          }
          if (id.includes('/components/Dashboard/')) {
            return 'c-dash';      // Was 'components-dashboard' (19) -> now 5 chars
          }
        },

        // Optimize asset file names for better caching
        assetFileNames: (assetInfo) => {
          const info = assetInfo.name.split('.');
          const ext = info[info.length - 1];
          if (/png|jpe?g|svg|gif|tiff|bmp|ico/i.test(ext)) {
            return `assets/images/[name]-[hash][extname]`;
          } else if (/woff|woff2|eot|ttf|otf/i.test(ext)) {
            return `assets/fonts/[name]-[hash][extname]`;
          }
          return `assets/[name]-[hash][extname]`;
        },
        // Use shorter paths to avoid LittleFS path length limit (~31 chars)
        // Changed from 'assets/js/' to 'js/' to reduce path length
        chunkFileNames: 'js/[name]-[hash].js',
        entryFileNames: 'js/[name]-[hash].js',
      },
    },
    chunkSizeWarningLimit: 600,
    cssCodeSplit: true, // Split CSS per component
    assetsInlineLimit: 4096, // Inline assets < 4KB as base64
    reportCompressedSize: true, // Show gzip sizes in build
    sourcemap: false, // Disable sourcemaps for production (smaller size)
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://192.168.178.54', // ESP32 IP - update as needed
        changeOrigin: true,
      },
    },
  },
  // Performance optimizations
  optimizeDeps: {
    include: ['preact', 'preact/hooks', 'htm'], // Pre-bundle these
  },
});


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/postcss.config.js
################################################################################

export default {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/public/sw.js
################################################################################

/**
 * Service Worker for ESP32 Thermostat PWA
 * Provides offline capability and caching for better performance
 */

const CACHE_NAME = 'esp32-thermostat-v1';
const RUNTIME_CACHE = 'esp32-thermostat-runtime';

// Assets to cache on install
const PRECACHE_ASSETS = [
  '/',
  '/index.html',
  '/manifest.json',
  '/favicon-32x32.png',
  '/apple-touch-icon.png',
];

// Install event - precache static assets
self.addEventListener('install', (event) => {
  console.log('[SW] Installing service worker...');

  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      console.log('[SW] Precaching static assets');
      return cache.addAll(PRECACHE_ASSETS);
    }).then(() => {
      console.log('[SW] Service worker installed successfully');
      return self.skipWaiting(); // Activate immediately
    })
  );
});

// Activate event - clean up old caches
self.addEventListener('activate', (event) => {
  console.log('[SW] Activating service worker...');

  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames
          .filter((name) => name !== CACHE_NAME && name !== RUNTIME_CACHE)
          .map((name) => {
            console.log('[SW] Deleting old cache:', name);
            return caches.delete(name);
          })
      );
    }).then(() => {
      console.log('[SW] Service worker activated');
      return self.clients.claim(); // Take control immediately
    })
  );
});

// Fetch event - serve from cache when possible
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // Skip cross-origin requests
  if (url.origin !== self.location.origin) {
    return;
  }

  // Skip API requests (always fetch fresh data)
  if (url.pathname.startsWith('/api/')) {
    return;
  }

  // Network-first strategy for HTML (to get latest app shell)
  if (request.mode === 'navigate') {
    event.respondWith(
      fetch(request)
        .then((response) => {
          // Cache the response
          const responseClone = response.clone();
          caches.open(RUNTIME_CACHE).then((cache) => {
            cache.put(request, responseClone);
          });
          return response;
        })
        .catch(() => {
          // Fallback to cache if offline
          return caches.match(request).then((cached) => {
            return cached || caches.match('/index.html');
          });
        })
    );
    return;
  }

  // Cache-first strategy for static assets (JS, CSS, images)
  event.respondWith(
    caches.match(request).then((cached) => {
      if (cached) {
        // Return cached version immediately
        return cached;
      }

      // Fetch from network and cache
      return fetch(request).then((response) => {
        // Only cache successful GET requests
        if (
          !response ||
          response.status !== 200 ||
          response.type === 'error' ||
          request.method !== 'GET'
        ) {
          return response;
        }

        const responseClone = response.clone();
        caches.open(RUNTIME_CACHE).then((cache) => {
          cache.put(request, responseClone);
        });

        return response;
      });
    })
  );
});

// Handle messages from the client
self.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'SKIP_WAITING') {
    self.skipWaiting();
  }

  if (event.data && event.data.type === 'CLEAR_CACHE') {
    event.waitUntil(
      caches.keys().then((cacheNames) => {
        return Promise.all(
          cacheNames.map((name) => caches.delete(name))
        );
      }).then(() => {
        console.log('[SW] All caches cleared');
        event.ports[0].postMessage({ success: true });
      })
    );
  }
});


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/index.css
################################################################################

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  * {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
}

/* Custom slider thumb styling */
@layer components {
  .slider-thumb::-webkit-slider-thumb {
    appearance: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #1e88e5;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
  }

  .slider-thumb::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }

  .slider-thumb::-moz-range-thumb {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #1e88e5;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    border: none;
    transition: all 0.2s ease;
  }

  .slider-thumb::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }

  .slider-thumb:disabled::-webkit-slider-thumb {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .slider-thumb:disabled::-moz-range-thumb {
    background: #9ca3af;
    cursor: not-allowed;
  }
}

/* Smooth animations */
@layer utilities {
  .animate-fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Page transition animations */
  .page-enter {
    animation: pageEnter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes pageEnter {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Card hover animations */
  .card-hover {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card-hover:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* Button press animation */
  .button-press {
    transition: all 0.1s ease;
  }

  .button-press:active {
    transform: scale(0.98);
  }

  /* Slide in from right */
  .slide-in-right {
    animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Pulse animation for live data indicators */
  .pulse-glow {
    animation: pulseGlow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulseGlow {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  /* Stagger children animations */
  .stagger-children > * {
    animation: fadeInStagger 0.4s cubic-bezier(0.4, 0, 0.2, 1) backwards;
  }

  .stagger-children > *:nth-child(1) { animation-delay: 0.05s; }
  .stagger-children > *:nth-child(2) { animation-delay: 0.1s; }
  .stagger-children > *:nth-child(3) { animation-delay: 0.15s; }
  .stagger-children > *:nth-child(4) { animation-delay: 0.2s; }
  .stagger-children > *:nth-child(5) { animation-delay: 0.25s; }
  .stagger-children > *:nth-child(6) { animation-delay: 0.3s; }

  @keyframes fadeInStagger {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Slide up animation for modals */
  .animate-slideUp {
    animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Fade in animation */
  .animate-fadeIn {
    animation: fadeInSimple 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeInSimple {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/main.jsx
################################################################################

import { h, render } from 'preact';
import htm from 'htm';
import Router from 'preact-router';
import { Toaster } from 'react-hot-toast';
import { ErrorBoundary } from './components/common/ErrorBoundary.jsx';
import { Layout } from './components/layout/Layout.jsx';
import { Dashboard } from './pages/Dashboard.jsx';
import { Status } from './pages/Status.jsx';
import { Config } from './pages/Config.jsx';
import { Logs } from './pages/Logs.jsx';
import { Serial } from './pages/Serial.jsx';
import './index.css'; // Tailwind CSS

const html = htm.bind(h);

/**
 * Main Application Entry Point
 * Implements client-side routing with Preact Router and error boundaries
 */
function App() {
  return html`
    <${ErrorBoundary}>
      <div>
        <${Layout}>
          <${Router}>
            <${Dashboard} path="/" />
            <${Status} path="/status" />
            <${Config} path="/config" />
            <${Logs} path="/logs" />
            <${Serial} path="/serial" />
          <//>
        <//>
        <${Toaster}
          position="top-center"
          reverseOrder=${false}
          gutter=${8}
          toastOptions=${{
            duration: 3000,
            style: {
              borderRadius: '12px',
              padding: '12px 16px',
              fontSize: '14px',
              fontWeight: '500',
              maxWidth: '500px',
            },
          }}
        />
      </div>
    <//>
  `;
}

// Mount app to DOM
render(html`<${App} />`, document.getElementById('app'));


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/utils/dataProcessing.js
################################################################################

/**
 * Data processing utilities for history data
 */

/**
 * Filter history data by time range
 *
 * @param {Object} data - History data with timestamps array
 * @param {number} hours - Number of hours to keep (from now)
 * @returns {Object} Filtered data
 */
export function filterByTimeRange(data, hours) {
  if (!data || !data.timestamps || data.timestamps.length === 0) {
    return null;
  }

  const nowSeconds = Math.floor(Date.now() / 1000);
  const cutoffTime = nowSeconds - (hours * 3600);

  const indices = [];
  for (let i = 0; i < data.timestamps.length; i++) {
    if (data.timestamps[i] >= cutoffTime) {
      indices.push(i);
    }
  }

  if (indices.length === 0) {
    return null;
  }

  return {
    timestamps: indices.map(i => data.timestamps[i]),
    temperatures: indices.map(i => data.temperatures[i]),
    humidities: indices.map(i => data.humidities[i]),
    pressures: indices.map(i => data.pressures ? data.pressures[i] : null),
    valvePositions: indices.map(i => data.valvePositions[i]),
    count: indices.length,
  };
}

/**
 * Get target number of points for a given time range
 * Implements the strategy from GRAPH_VISUALIZATION_REFACTOR.md
 *
 * @param {number} hours - Time range in hours
 * @returns {number} Target number of points
 */
export function getTargetPoints(hours) {
  switch (hours) {
    case 1:
      return 120;  // Full resolution for 1 hour
    case 4:
      return 275;  // LTTB downsampling
    case 12:
      return 275;  // LTTB downsampling
    case 24:
      return 350;  // LTTB downsampling
    default:
      return 300;  // Default
  }
}

/**
 * Format timestamp for display based on time range
 *
 * @param {number} timestamp - Unix timestamp in seconds
 * @param {number} timeRange - Time range in hours
 * @returns {string} Formatted time string
 */
export function formatTimestamp(timestamp, timeRange) {
  const date = new Date(timestamp * 1000);

  if (timeRange <= 4) {
    // For short ranges, show hours:minutes
    return date.toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
    });
  } else {
    // For longer ranges, show date + time
    return date.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }
}

/**
 * Calculate statistics for a dataset
 *
 * @param {number[]} values - Array of numeric values
 * @returns {Object} Statistics {min, max, avg, latest}
 */
export function calculateStats(values) {
  if (!values || values.length === 0) {
    return { min: null, max: null, avg: null, latest: null };
  }

  const min = Math.min(...values);
  const max = Math.max(...values);
  const sum = values.reduce((acc, val) => acc + val, 0);
  const avg = sum / values.length;
  const latest = values[values.length - 1];

  return {
    min: min.toFixed(1),
    max: max.toFixed(1),
    avg: avg.toFixed(1),
    latest: latest.toFixed(1),
  };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/utils/lttb.js
################################################################################

/**
 * Largest-Triangle-Three-Buckets (LTTB) Downsampling Algorithm
 *
 * Reduces the number of data points while preserving the visual characteristics
 * of the time series. Particularly good at preserving peaks, valleys, and trends.
 *
 * Reference: https://skemman.is/bitstream/1946/15343/3/SS_MSthesis.pdf
 *
 * @param {Array<{x: number, y: number}>} data - Array of data points
 * @param {number} threshold - Target number of points after downsampling
 * @returns {Array<{x: number, y: number}>} Downsampled data
 */
export function lttb(data, threshold) {
  if (!data || data.length === 0) {
    return [];
  }

  if (threshold >= data.length || threshold === 0) {
    return data; // Nothing to do
  }

  if (threshold < 3) {
    throw new Error('Threshold must be >= 3');
  }

  const sampled = [];
  const bucketSize = (data.length - 2) / (threshold - 2);

  let a = 0; // Initially a is the first point
  sampled.push(data[a]); // Always add the first point

  for (let i = 0; i < threshold - 2; i++) {
    // Calculate point average for next bucket (containing c)
    let avgX = 0;
    let avgY = 0;
    let avgRangeStart = Math.floor((i + 1) * bucketSize) + 1;
    let avgRangeEnd = Math.floor((i + 2) * bucketSize) + 1;
    avgRangeEnd = avgRangeEnd < data.length ? avgRangeEnd : data.length;

    const avgRangeLength = avgRangeEnd - avgRangeStart;

    for (; avgRangeStart < avgRangeEnd; avgRangeStart++) {
      avgX += data[avgRangeStart].x;
      avgY += data[avgRangeStart].y;
    }
    avgX /= avgRangeLength;
    avgY /= avgRangeLength;

    // Get the range for this bucket
    let rangeOffs = Math.floor((i + 0) * bucketSize) + 1;
    const rangeTo = Math.floor((i + 1) * bucketSize) + 1;

    // Point a
    const pointAX = data[a].x;
    const pointAY = data[a].y;

    let maxArea = -1;
    let maxAreaPoint = null;
    let nextA = null;

    for (; rangeOffs < rangeTo; rangeOffs++) {
      // Calculate triangle area over three buckets
      const area = Math.abs(
        (pointAX - avgX) * (data[rangeOffs].y - pointAY) -
        (pointAX - data[rangeOffs].x) * (avgY - pointAY)
      ) * 0.5;

      if (area > maxArea) {
        maxArea = area;
        maxAreaPoint = data[rangeOffs];
        nextA = rangeOffs; // Remember which point we picked
      }
    }

    sampled.push(maxAreaPoint); // Pick the point with the largest triangle
    a = nextA; // This point is the next a (chosen b_i)
  }

  sampled.push(data[data.length - 1]); // Always add the last point

  return sampled;
}

/**
 * Helper function to convert timestamp/value arrays to point objects
 *
 * @param {number[]} timestamps - Array of Unix timestamps
 * @param {number[]} values - Array of values
 * @returns {Array<{x: number, y: number}>} Array of point objects
 */
export function toPoints(timestamps, values) {
  if (!timestamps || !values || timestamps.length !== values.length) {
    return [];
  }

  return timestamps.map((timestamp, index) => ({
    x: timestamp,
    y: values[index],
  }));
}

/**
 * Helper function to convert point objects back to separate arrays
 *
 * @param {Array<{x: number, y: number}>} points - Array of point objects
 * @returns {{timestamps: number[], values: number[]}} Separate arrays
 */
export function fromPoints(points) {
  if (!points || points.length === 0) {
    return { timestamps: [], values: [] };
  }

  return {
    timestamps: points.map(p => p.x),
    values: points.map(p => p.y),
  };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/utils/validation.js
################################################################################

/**
 * Form Validation Utilities
 * Real-time validation for configuration parameters
 * Implements form validation from PREACT_UX_IMPROVEMENTS.md
 */

/**
 * Validates PID parameters
 * @param {number} value - The parameter value
 * @param {string} param - Parameter name (kp, ki, kd)
 * @returns {Object} { isValid: boolean, error: string }
 */
export function validatePID(value, param) {
  const num = parseFloat(value);

  // Check if it's a number
  if (isNaN(num)) {
    return {
      isValid: false,
      error: 'Must be a valid number',
    };
  }

  // Parameter-specific validation
  switch (param.toLowerCase()) {
    case 'kp': // Proportional gain
      if (num < 0.1 || num > 100) {
        return {
          isValid: false,
          error: 'Kp must be between 0.1 and 100',
        };
      }
      break;

    case 'ki': // Integral gain
      if (num < 0 || num > 10) {
        return {
          isValid: false,
          error: 'Ki must be between 0 and 10',
        };
      }
      break;

    case 'kd': // Derivative gain
      if (num < 0 || num > 10) {
        return {
          isValid: false,
          error: 'Kd must be between 0 and 10',
        };
      }
      break;

    default:
      return {
        isValid: false,
        error: 'Unknown PID parameter',
      };
  }

  return {
    isValid: true,
    error: null,
  };
}

/**
 * Validates WiFi SSID
 * @param {string} ssid - WiFi SSID
 * @returns {Object} { isValid: boolean, error: string }
 */
export function validateSSID(ssid) {
  if (!ssid || ssid.trim().length === 0) {
    return {
      isValid: false,
      error: 'SSID cannot be empty',
    };
  }

  if (ssid.length > 32) {
    return {
      isValid: false,
      error: 'SSID cannot exceed 32 characters',
    };
  }

  return {
    isValid: true,
    error: null,
  };
}

/**
 * Validates MQTT broker address
 * @param {string} broker - MQTT broker address
 * @returns {Object} { isValid: boolean, error: string }
 */
export function validateBroker(broker) {
  if (!broker || broker.trim().length === 0) {
    return {
      isValid: false,
      error: 'Broker address cannot be empty',
    };
  }

  // Basic hostname/IP validation
  const hostnameRegex = /^[a-zA-Z0-9.-]+$/;
  if (!hostnameRegex.test(broker)) {
    return {
      isValid: false,
      error: 'Invalid broker address format',
    };
  }

  return {
    isValid: true,
    error: null,
  };
}

/**
 * Validates MQTT port
 * @param {number} port - MQTT port
 * @returns {Object} { isValid: boolean, error: string }
 */
export function validatePort(port) {
  const num = parseInt(port);

  if (isNaN(num)) {
    return {
      isValid: false,
      error: 'Must be a valid number',
    };
  }

  if (num < 1 || num > 65535) {
    return {
      isValid: false,
      error: 'Port must be between 1 and 65535',
    };
  }

  return {
    isValid: true,
    error: null,
  };
}

/**
 * Validates temperature setpoint
 * @param {number} temp - Temperature in Celsius
 * @returns {Object} { isValid: boolean, error: string }
 */
export function validateTemperature(temp) {
  const num = parseFloat(temp);

  if (isNaN(num)) {
    return {
      isValid: false,
      error: 'Must be a valid number',
    };
  }

  if (num < 5 || num > 35) {
    return {
      isValid: false,
      error: 'Temperature must be between 5°C and 35°C',
    };
  }

  return {
    isValid: true,
    error: null,
  };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/utils/toast.js
################################################################################

import toast from 'react-hot-toast';

/**
 * Toast Notification Utilities
 * Wrapper around react-hot-toast with custom styling
 * Implements toast notifications from PREACT_UX_IMPROVEMENTS.md
 */

// Default toast options
const defaultOptions = {
  duration: 3000,
  position: 'top-center',
  style: {
    borderRadius: '12px',
    padding: '12px 16px',
    fontSize: '14px',
    maxWidth: '500px',
  },
};

/**
 * Success toast notification
 * @param {string} message - Success message to display
 */
export function showSuccess(message) {
  return toast.success(message, {
    ...defaultOptions,
    icon: '✅',
    style: {
      ...defaultOptions.style,
      background: '#10b981',
      color: '#ffffff',
    },
  });
}

/**
 * Error toast notification
 * @param {string} message - Error message to display
 */
export function showError(message) {
  return toast.error(message, {
    ...defaultOptions,
    duration: 4000, // Errors stay longer
    icon: '❌',
    style: {
      ...defaultOptions.style,
      background: '#ef4444',
      color: '#ffffff',
    },
  });
}

/**
 * Info toast notification
 * @param {string} message - Info message to display
 */
export function showInfo(message) {
  return toast(message, {
    ...defaultOptions,
    icon: 'ℹ️',
    style: {
      ...defaultOptions.style,
      background: '#3b82f6',
      color: '#ffffff',
    },
  });
}

/**
 * Warning toast notification
 * @param {string} message - Warning message to display
 */
export function showWarning(message) {
  return toast(message, {
    ...defaultOptions,
    icon: '⚠️',
    style: {
      ...defaultOptions.style,
      background: '#f59e0b',
      color: '#ffffff',
    },
  });
}

/**
 * Loading toast notification
 * @param {string} message - Loading message to display
 * @returns {string} Toast ID (use with toast.dismiss(id))
 */
export function showLoading(message) {
  return toast.loading(message, {
    ...defaultOptions,
    duration: Infinity, // Loading toasts don't auto-dismiss
    style: {
      ...defaultOptions.style,
      background: '#6b7280',
      color: '#ffffff',
    },
  });
}

/**
 * Promise toast - shows loading/success/error based on promise state
 * @param {Promise} promise - Promise to track
 * @param {Object} messages - Messages for each state {loading, success, error}
 */
export function showPromise(promise, messages) {
  return toast.promise(
    promise,
    {
      loading: messages.loading,
      success: messages.success,
      error: messages.error,
    },
    {
      ...defaultOptions,
      success: {
        icon: '✅',
        style: {
          ...defaultOptions.style,
          background: '#10b981',
          color: '#ffffff',
        },
      },
      error: {
        icon: '❌',
        style: {
          ...defaultOptions.style,
          background: '#ef4444',
          color: '#ffffff',
        },
      },
    }
  );
}

/**
 * Dismiss a specific toast or all toasts
 * @param {string} [id] - Optional toast ID to dismiss specific toast
 */
export function dismissToast(id) {
  if (id) {
    toast.dismiss(id);
  } else {
    toast.dismiss();
  }
}

export default {
  success: showSuccess,
  error: showError,
  info: showInfo,
  warning: showWarning,
  loading: showLoading,
  promise: showPromise,
  dismiss: dismissToast,
};


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/layout/Layout.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';
import { Link } from 'preact-router/match';
import { useDarkMode } from '../../hooks/useDarkMode.js';
import { useSystemInfo } from '../../hooks/useSystemInfo.js';

const html = htm.bind(h);

/**
 * Layout Component
 * Shared layout with navigation for all pages
 * Implements responsive navigation with mobile menu and dark mode toggle
 *
 * @param {Object} props
 * @param {preact.ComponentChildren} props.children - Page content
 */
export function Layout({ children }) {
  const { isDark, toggle } = useDarkMode();
  const { version } = useSystemInfo();

  const navItems = [
    { path: '/', label: 'Dashboard' },
    { path: '/status', label: 'Status' },
    { path: '/config', label: 'Config' },
    { path: '/logs', label: 'Logs' },
    { path: '/serial', label: 'Serial' },
  ];

  return html`
    <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
      <!-- Header with Navigation -->
      <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center py-4">
            <!-- Logo/Title -->
            <div class="flex items-center">
              <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">
                ESP32 Thermostat
              </h1>
            </div>

            <!-- Desktop Navigation + Dark Mode -->
            <div class="hidden md:flex items-center gap-2">
              <nav class="flex gap-2">
                ${navItems.map(({ path, label }) => html`
                  <${Link}
                    key=${path}
                    href=${path}
                    activeClassName="bg-primary-500 text-white"
                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:bg-primary-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300"
                  >
                    ${label}
                  <//>
                `)}
              </nav>

              <!-- Dark Mode Toggle -->
              <button
                onClick=${toggle}
                class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all ml-2"
                title=${isDark ? 'Switch to light mode' : 'Switch to dark mode'}
              >
                ${isDark ? html`
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                ` : html`
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                  </svg>
                `}
              </button>
            </div>

            <!-- Mobile Dark Mode Toggle -->
            <div class="md:hidden">
              <button
                onClick=${toggle}
                class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all"
                title=${isDark ? 'Switch to light mode' : 'Switch to dark mode'}
              >
                ${isDark ? html`
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                ` : html`
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                  </svg>
                `}
              </button>
            </div>
          </div>

          <!-- Mobile Navigation (Visible on small screens) -->
          <nav class="md:hidden flex overflow-x-auto pb-3 gap-2 -mx-4 px-4">
            ${navItems.map(({ path, label }) => html`
              <${Link}
                key=${path}
                href=${path}
                activeClassName="bg-primary-500 text-white"
                class="flex-shrink-0 px-3 py-2 rounded-lg font-medium transition-all duration-200 text-gray-700 dark:text-gray-300 text-sm whitespace-nowrap"
              >
                ${label}
              <//>
            `)}
          </nav>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        ${children}
      </main>

      <!-- Footer -->
      <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <p class="text-center text-sm text-gray-500 dark:text-gray-400">
            ESP32 KNX Thermostat © ${new Date().getFullYear()}
            ${version ? html`<span class="ml-2">· v${version}</span>` : ''}
          </p>
        </div>
      </footer>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Graph/TimeRangeSelector.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';

const html = htm.bind(h);

/**
 * TimeRangeSelector Component
 * Renders button group for selecting time range (1h, 4h, 12h, 24h)
 * Implements design from GRAPH_VISUALIZATION_REFACTOR.md
 *
 * @param {Object} props
 * @param {number} props.selected - Currently selected time range in hours
 * @param {Function} props.onChange - Callback when selection changes
 */
export function TimeRangeSelector({ selected, onChange }) {
  const ranges = [
    { hours: 1, label: '1h' },
    { hours: 4, label: '4h' },
    { hours: 12, label: '12h' },
    { hours: 24, label: '24h' },
  ];

  return html`
    <div class="flex gap-2 justify-center mb-4">
      ${ranges.map(({ hours, label }) => html`
        <button
          key=${hours}
          onClick=${() => onChange(hours)}
          class=${`
            px-4 py-2 rounded-lg font-medium transition-all duration-200
            ${selected === hours
              ? 'bg-primary-500 text-white shadow-md scale-105'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600'
            }
          `}
        >
          ${label}
        </button>
      `)}
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Graph/HistoryChart.jsx
################################################################################

import { h } from 'preact';
import { useEffect, useRef } from 'preact/hooks';
import htm from 'htm';
import uPlot from 'uplot';
import 'uplot/dist/uPlot.min.css';

const html = htm.bind(h);

/**
 * HistoryChart Component
 * Renders time-series chart using uPlot with dual Y-axes
 * Implements spec from GRAPH_VISUALIZATION_REFACTOR.md
 *
 * @param {Object} props
 * @param {number[]} props.timestamps - Unix timestamps in seconds
 * @param {number[]} props.temperatures - Temperature values in °C
 * @param {number[]} props.humidities - Humidity values in %
 * @param {number[]} props.valvePositions - Valve position values 0-100%
 * @param {number} props.timeRange - Selected time range in hours
 */
export function HistoryChart({
  timestamps,
  temperatures,
  humidities,
  valvePositions,
  timeRange,
}) {
  const chartRef = useRef(null);
  const plotRef = useRef(null);

  // Calculate responsive chart height based on viewport
  const getResponsiveHeight = () => {
    const vh = window.innerHeight;
    if (vh < 600) return 250;    // Mobile: 250px
    if (vh < 900) return 300;    // Tablet: 300px
    return 400;                   // Desktop: 400px
  };

  useEffect(() => {
    if (!chartRef.current || !timestamps || timestamps.length === 0) {
      return;
    }

    // Validate and sanitize data arrays
    // uPlot requires arrays of equal length, and null/undefined values should be null
    const sanitizeArray = (arr, defaultValue = null) => {
      if (!arr || !Array.isArray(arr)) return [];
      return arr.map(val => (val === undefined || val === null || isNaN(val)) ? null : Number(val));
    };

    const sanitizedTimestamps = sanitizeArray(timestamps);
    const sanitizedTemperatures = sanitizeArray(temperatures);
    const sanitizedHumidities = sanitizeArray(humidities);
    const sanitizedValvePositions = sanitizeArray(valvePositions);

    // Ensure all arrays have the same length (pad with null if needed)
    const maxLength = Math.max(
      sanitizedTimestamps.length,
      sanitizedTemperatures.length,
      sanitizedHumidities.length,
      sanitizedValvePositions.length
    );

    const padArray = (arr, length) => {
      const padded = [...arr];
      while (padded.length < length) {
        padded.push(null);
      }
      return padded;
    };

    // Prepare data in uPlot format [timestamps, temp, humidity, valve]
    const data = [
      padArray(sanitizedTimestamps, maxLength),
      padArray(sanitizedTemperatures, maxLength),
      padArray(sanitizedHumidities, maxLength),
      padArray(sanitizedValvePositions, maxLength),
    ];

    // Debug logging (remove in production if needed)
    if (process.env.NODE_ENV === 'development') {
      console.log('[HistoryChart] Data summary:', {
        timestamps: data[0].length,
        temperatures: data[1].filter(v => v !== null).length,
        humidities: data[2].filter(v => v !== null).length,
        valvePositions: data[3].filter(v => v !== null).length,
        sampleTemp: data[1].slice(0, 3),
        sampleHumid: data[2].slice(0, 3),
        sampleValve: data[3].slice(0, 3),
      });
    }

    // Configure uPlot options
    const opts = {
      width: chartRef.current.offsetWidth,
      height: getResponsiveHeight(),
      plugins: [],
      scales: {
        x: {
          time: true,
        },
        y: {
          auto: true,
          range: (self, dataMin, dataMax) => {
            // Add 10% padding to temperature axis
            const padding = (dataMax - dataMin) * 0.1;
            return [dataMin - padding, dataMax + padding];
          },
        },
        '%': {
          auto: false, // Fixed range for percentage
          range: [0, 100],
        },
      },
      axes: [
        {
          // X-axis (time)
          space: 60,
          values: (self, ticks) => {
            return ticks.map(t => {
              const date = new Date(t * 1000);
              if (timeRange <= 4) {
                // Short range: show time only
                return date.toLocaleTimeString('en-US', {
                  hour: '2-digit',
                  minute: '2-digit',
                });
              } else {
                // Long range: show date + time
                return date.toLocaleString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                });
              }
            });
          },
        },
        {
          // Left Y-axis (temperature)
          scale: 'y',
          values: (self, ticks) => ticks.map(t => t.toFixed(1) + '°C'),
          stroke: '#1e88e5',
          font: '12px Arial',
          gap: 5,
        },
        {
          // Right Y-axis (humidity & valve)
          scale: '%',
          values: (self, ticks) => ticks.map(t => t.toFixed(0) + '%'),
          stroke: '#ff9800',
          font: '12px Arial',
          gap: 5,
          side: 1, // Right side
        },
      ],
      series: [
        {
          // Timestamps (x-axis data)
        },
        {
          // Temperature
          label: 'Temperature',
          stroke: '#1e88e5',
          width: 2,
          scale: 'y',
          value: (self, rawValue) => {
            if (rawValue === null || rawValue === undefined || isNaN(rawValue)) {
              return '--';
            }
            return rawValue.toFixed(1) + '°C';
          },
        },
        {
          // Humidity
          label: 'Humidity',
          stroke: '#4caf50',
          width: 2,
          scale: '%',
          value: (self, rawValue) => {
            if (rawValue === null || rawValue === undefined || isNaN(rawValue)) {
              return '--';
            }
            return rawValue.toFixed(1) + '%';
          },
        },
        {
          // Valve Position
          label: 'Valve',
          stroke: '#ff9800',
          width: 2,
          scale: '%',
          value: (self, rawValue) => {
            if (rawValue === null || rawValue === undefined || isNaN(rawValue)) {
              return '--';
            }
            return rawValue.toFixed(0) + '%';
          },
          dash: [5, 5], // Dashed line
        },
      ],
      legend: {
        show: true,
        live: true,
      },
      cursor: {
        drag: {
          x: false,
          y: false,
        },
      },
    };

    // Create or update plot
    if (plotRef.current) {
      plotRef.current.setData(data);
      plotRef.current.setSize({
        width: chartRef.current.offsetWidth,
        height: getResponsiveHeight(),
      });
    } else {
      plotRef.current = new uPlot(opts, data, chartRef.current);
    }

    // Handle window resize
    const handleResize = () => {
      if (plotRef.current && chartRef.current) {
        plotRef.current.setSize({
          width: chartRef.current.offsetWidth,
          height: getResponsiveHeight(),
        });
      }
    };

    window.addEventListener('resize', handleResize);

    // Cleanup
    return () => {
      window.removeEventListener('resize', handleResize);
      if (plotRef.current) {
        plotRef.current.destroy();
        plotRef.current = null;
      }
    };
  }, [timestamps, temperatures, humidities, valvePositions, timeRange]);

  return html`
    <div class="w-full" ref=${chartRef}></div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Graph/GraphContainer.jsx
################################################################################

import { h } from 'preact';
import { useState, useMemo } from 'preact/hooks';
import htm from 'htm';
import { useHistoryData } from '../../hooks/useHistoryData.js';
import { filterByTimeRange, getTargetPoints } from '../../utils/dataProcessing.js';
import { lttb, toPoints, fromPoints } from '../../utils/lttb.js';
import { TimeRangeSelector } from './TimeRangeSelector.jsx';
import { DataPointsBadge } from './DataPointsBadge.jsx';
import { HistoryChart } from './HistoryChart.jsx';

const html = htm.bind(h);

/**
 * GraphContainer Component
 * Main orchestrator for graph visualization with LTTB downsampling
 * Implements complete spec from GRAPH_VISUALIZATION_REFACTOR.md
 */
export function GraphContainer() {
  const [timeRange, setTimeRange] = useState(24); // Default: 24 hours
  const { data: rawData, loading, error } = useHistoryData(30000); // Poll every 30s

  // Process data: filter by time range → downsample with LTTB
  const processedData = useMemo(() => {
    if (!rawData || !rawData.timestamps || rawData.timestamps.length === 0) {
      return null;
    }

    // Step 1: Filter by selected time range
    const filtered = filterByTimeRange(rawData, timeRange);
    if (!filtered || filtered.count === 0) {
      return null;
    }

    // Step 2: Determine if downsampling is needed
    const targetPoints = getTargetPoints(timeRange);
    const needsDownsampling = filtered.count > targetPoints;

    if (!needsDownsampling) {
      // Return filtered data as-is
      return {
        timestamps: filtered.timestamps,
        temperatures: filtered.temperatures,
        humidities: filtered.humidities,
        valvePositions: filtered.valvePositions,
        downsampledCount: filtered.count,
        originalCount: rawData.count,
        downsampled: false,
      };
    }

    // Step 3: Downsample each dataset with LTTB
    const tempPoints = toPoints(filtered.timestamps, filtered.temperatures);
    const humidPoints = toPoints(filtered.timestamps, filtered.humidities);
    const valvePoints = toPoints(filtered.timestamps, filtered.valvePositions);

    const sampledTemp = lttb(tempPoints, targetPoints);
    const sampledHumid = lttb(humidPoints, targetPoints);
    const sampledValve = lttb(valvePoints, targetPoints);

    // Use temperature timestamps as primary (all should be similar after LTTB)
    const { timestamps, values: temperatures } = fromPoints(sampledTemp);
    const { values: humidities } = fromPoints(sampledHumid);
    const { values: valvePositions } = fromPoints(sampledValve);

    return {
      timestamps,
      temperatures,
      humidities,
      valvePositions,
      downsampledCount: timestamps.length,
      originalCount: rawData.count,
      downsampled: true,
    };
  }, [rawData, timeRange]);

  // Loading state
  if (loading) {
    return html`
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="animate-pulse space-y-4">
          <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded w-64 mx-auto"></div>
          <div class="h-64 bg-gray-200 dark:bg-gray-700 rounded"></div>
          <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-48"></div>
        </div>
      </div>
    `;
  }

  // Error state
  if (error) {
    return html`
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="text-center py-8">
          <div class="text-red-500 text-5xl mb-4">⚠️</div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Failed to Load History Data
          </h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">${error}</p>
          <button
            onClick=${() => window.location.reload()}
            class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600"
          >
            Retry
          </button>
        </div>
      </div>
    `;
  }

  // No data state
  if (!processedData) {
    return html`
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="text-center py-8">
          <div class="text-gray-400 text-5xl mb-4">📊</div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            No Data Available
          </h3>
          <p class="text-gray-600 dark:text-gray-400">
            ${timeRange}h time range has no data points yet.
          </p>
        </div>
      </div>
    `;
  }

  // Render chart with data
  return html`
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        Historical Data
      </h2>

      <!-- Time Range Selector -->
      <${TimeRangeSelector}
        selected=${timeRange}
        onChange=${setTimeRange}
      />

      <!-- Chart -->
      <div class="mb-4">
        <${HistoryChart}
          timestamps=${processedData.timestamps}
          temperatures=${processedData.temperatures}
          humidities=${processedData.humidities}
          valvePositions=${processedData.valvePositions}
          timeRange=${timeRange}
        />
      </div>

      <!-- Data Points Badge -->
      <div class="flex justify-end">
        <${DataPointsBadge}
          showing=${processedData.downsampledCount}
          total=${processedData.originalCount}
          downsampled=${processedData.downsampled}
        />
      </div>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Graph/DataPointsBadge.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';

const html = htm.bind(h);

/**
 * DataPointsBadge Component
 * Shows transparency indicator for downsampled data
 * Implements design from GRAPH_VISUALIZATION_REFACTOR.md
 *
 * @param {Object} props
 * @param {number} props.showing - Number of points currently displayed
 * @param {number} props.total - Total number of points in dataset
 * @param {boolean} props.downsampled - Whether data was downsampled
 */
export function DataPointsBadge({ showing, total, downsampled = false }) {
  const formatNumber = (num) => num.toLocaleString();

  return html`
    <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
      <span>
        Showing ${formatNumber(showing)} of ${formatNumber(total)} points
      </span>
      ${downsampled && html`
        <span
          class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded text-xs font-medium"
          title="Data downsampled using LTTB algorithm for optimal performance while preserving visual fidelity"
        >
          LTTB
        </span>
      `}
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Dashboard/SensorCard.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';
import { useSensorData } from '../../hooks/useSensorData.js';

const html = htm.bind(h);

/**
 * SensorCard Component
 * Displays current sensor readings with loading and error states
 * Implements skeleton loading from PREACT_UX_IMPROVEMENTS.md
 */
export function SensorCard() {
  const { data, loading, error } = useSensorData(5000); // Poll every 5 seconds

  // Skeleton Loading State (show if loading OR data is null)
  if (loading || !data) {
    return html`
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="animate-pulse">
          <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-40 mb-4"></div>
          <div class="space-y-3">
            ${[...Array(4)].map(() => html`
              <div class="flex justify-between items-center">
                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-24"></div>
                <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-20"></div>
              </div>
            `)}
          </div>
        </div>
      </div>
    `;
  }

  // Error State
  if (error) {
    return html`
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          Current Readings
        </h2>
        <div class="text-center py-4">
          <div class="text-red-500 text-3xl mb-2">⚠️</div>
          <p class="text-red-600 dark:text-red-400 text-sm">${error}</p>
        </div>
      </div>
    `;
  }

  // Data State
  const readings = [
    {
      label: 'Temperature',
      value: data?.temperature != null ? `${data.temperature.toFixed(1)}°C` : '--',
      color: 'text-blue-600 dark:text-blue-400',
    },
    {
      label: 'Humidity',
      value: data?.humidity != null ? `${data.humidity.toFixed(1)}%` : '--',
      color: 'text-green-600 dark:text-green-400',
    },
    {
      label: 'Pressure',
      value: data?.pressure != null ? `${data.pressure.toFixed(0)} hPa` : '--',
      color: 'text-purple-600 dark:text-purple-400',
    },
    {
      label: 'Valve Position',
      value: data?.valve != null ? `${data.valve}%` : '--',
      color: 'text-orange-600 dark:text-orange-400',
    },
  ];

  return html`
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        Current Readings
      </h2>
      <div class="space-y-3">
        ${readings.map(({ label, value, color }) => html`
          <div class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
            <span class="text-gray-600 dark:text-gray-400">${label}</span>
            <span class="${color} text-lg font-semibold">${value}</span>
          </div>
        `)}
      </div>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Dashboard/ControlCard.jsx
################################################################################

import { h } from 'preact';
import { useState, useCallback, useEffect } from 'preact/hooks';
import htm from 'htm';
import { usePresets } from '../../hooks/usePresets.js';
import { useSensorData } from '../../hooks/useSensorData.js';
import toast from '../../utils/toast.js';

const html = htm.bind(h);

/**
 * ControlCard Component
 * Temperature setpoint and preset mode controls
 * Implements optimistic updates from PREACT_UX_IMPROVEMENTS.md
 */
export function ControlCard() {
  const { presetMode, presetConfig, applyPreset, getPresetTemperature } = usePresets();
  const { data: sensorData } = useSensorData(5000);

  const [setpoint, setSetpoint] = useState(22.0);
  const [isUpdating, setIsUpdating] = useState(false);
  const [error, setError] = useState(null);

  // Sync setpoint with backend when sensorData updates
  useEffect(() => {
    if (sensorData?.setpoint != null) {
      setSetpoint(sensorData.setpoint);
    }
  }, [sensorData?.setpoint]);

  // Optimistic preset change
  const handlePresetChange = useCallback(async (e) => {
    const newMode = e.target.value;

    try {
      await applyPreset(newMode);

      // Update setpoint slider to match preset temperature
      const presetTemp = getPresetTemperature(newMode);
      if (presetTemp) {
        setSetpoint(presetTemp);
      }

      toast.success(`Preset changed to ${newMode === 'none' ? 'Manual' : newMode}`);
    } catch (err) {
      toast.error('Failed to change preset mode');
    }
  }, [applyPreset, getPresetTemperature]);

  // Setpoint change with optimistic update
  const handleSetpointChange = useCallback(async () => {
    const previousSetpoint = sensorData?.setpoint || setpoint;
    setIsUpdating(true);
    setError(null);

    try {
      const response = await fetch('/api/setpoint', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `value=${setpoint}`,
      });

      if (!response.ok) {
        throw new Error('Failed to update setpoint');
      }

      toast.success(`Temperature set to ${setpoint.toFixed(1)}°C`);
    } catch (err) {
      // Rollback on error
      setSetpoint(previousSetpoint);
      setError(err.message);
      toast.error(`Failed to update setpoint: ${err.message}`);
    } finally {
      setIsUpdating(false);
    }
  }, [setpoint, sensorData]);

  // Get current preset temperature for display
  const currentPresetTemp = getPresetTemperature(presetMode);

  return html`
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        Controls
      </h2>

      <!-- Preset Mode Selector -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Preset Mode
        </label>
        <div class="flex items-center gap-3">
          <select
            value=${presetMode}
            onChange=${handlePresetChange}
            class="flex-1 px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
          >
            <option value="none">None (Manual)</option>
            <option value="eco">🌱 Eco</option>
            <option value="comfort">🏠 Comfort</option>
            <option value="away">✈️ Away</option>
            <option value="sleep">😴 Sleep</option>
            <option value="boost">🔥 Boost</option>
          </select>
          ${currentPresetTemp && html`
            <span class="text-sm font-medium text-primary-600 dark:text-primary-400 min-w-[60px] text-right">
              ${currentPresetTemp.toFixed(1)}°C
            </span>
          `}
        </div>
      </div>

      <!-- Temperature Setpoint Slider -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Temperature Setpoint
        </label>

        <!-- Mobile-Optimized Slider with Floating Value -->
        <div class="relative mb-4">
          <input
            type="range"
            min="15"
            max="30"
            step="0.5"
            value=${setpoint}
            onInput=${(e) => setSetpoint(parseFloat(e.target.value))}
            class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"
            style="background: linear-gradient(to right, #1e88e5 0%, #1e88e5 ${((setpoint - 15) / 15) * 100}%, rgb(229 231 235) ${((setpoint - 15) / 15) * 100}%, rgb(229 231 235) 100%)"
          />

          <!-- Floating Value Display -->
          <div
            class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-primary-500 text-white px-3 py-1 rounded-lg text-lg font-bold shadow-lg"
            style="left: ${((setpoint - 15) / 15) * 100}%"
          >
            ${setpoint.toFixed(1)}°C
            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-primary-500"></div>
          </div>
        </div>

        <!-- Min/Max Labels -->
        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-4">
          <span>15°C</span>
          <span>30°C</span>
        </div>
      </div>

      <!-- Set Button -->
      <button
        onClick=${handleSetpointChange}
        disabled=${isUpdating}
        class="w-full px-4 py-3 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white font-medium rounded-lg transition-all duration-200 shadow-md hover:shadow-lg disabled:cursor-not-allowed"
      >
        ${isUpdating ? 'Updating...' : 'Set Temperature'}
      </button>

      <!-- Error Display -->
      ${error && html`
        <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <p class="text-sm text-red-600 dark:text-red-400">${error}</p>
        </div>
      `}
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Dashboard/ManualOverrideCard.jsx
################################################################################

import { h } from 'preact';
import { useState, useEffect, useCallback } from 'preact/hooks';
import htm from 'htm';
import toast from '../../utils/toast.js';

const html = htm.bind(h);

/**
 * ManualOverrideCard Component
 * Manual valve position control with countdown timer
 * Implements optimistic updates from PREACT_UX_IMPROVEMENTS.md
 */
export function ManualOverrideCard() {
  const [overrideEnabled, setOverrideEnabled] = useState(false);
  const [valvePosition, setValvePosition] = useState(0);
  const [isUpdating, setIsUpdating] = useState(false);
  const [error, setError] = useState(null);
  const [remainingTime, setRemainingTime] = useState(null);

  // Fetch current override state
  useEffect(() => {
    const fetchOverrideState = async () => {
      try {
        const response = await fetch('/api/manual-override');
        const data = await response.json();
        setOverrideEnabled(data.enabled || false);
        setValvePosition(data.position || 0);
        setRemainingTime(data.remainingSeconds || null);
      } catch (err) {
        // Silently fail initial fetch
      }
    };

    fetchOverrideState();
    const interval = setInterval(fetchOverrideState, 5000);
    return () => clearInterval(interval);
  }, []);

  // Countdown timer
  useEffect(() => {
    if (!overrideEnabled || !remainingTime) return;

    const interval = setInterval(() => {
      setRemainingTime(prev => {
        if (prev <= 1) {
          setOverrideEnabled(false);
          return null;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [overrideEnabled, remainingTime]);

  // Toggle override mode
  const handleToggleOverride = useCallback(async () => {
    const newState = !overrideEnabled;
    const previousState = overrideEnabled;

    // Optimistic update
    setOverrideEnabled(newState);
    setIsUpdating(true);
    setError(null);

    try {
      const params = new URLSearchParams();
      params.append('enabled', newState);
      if (newState) {
        params.append('position', valvePosition);
      }

      const response = await fetch('/api/manual-override', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString(),
      });

      if (!response.ok) {
        throw new Error('Failed to toggle override');
      }

      if (newState) {
        setRemainingTime(1800); // 30 minutes default
        toast.success('Manual override enabled');
      } else {
        setRemainingTime(null);
        setValvePosition(0);
        toast.info('Manual override disabled');
      }
    } catch (err) {
      // Rollback on error
      setOverrideEnabled(previousState);
      setError(err.message);
      toast.error(`Failed to toggle override: ${err.message}`);
    } finally {
      setIsUpdating(false);
    }
  }, [overrideEnabled, valvePosition]);

  // Update valve position
  const handleSetValvePosition = useCallback(async () => {
    setIsUpdating(true);
    setError(null);

    try {
      const params = new URLSearchParams();
      params.append('enabled', true);
      params.append('position', valvePosition);

      const response = await fetch('/api/manual-override', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString(),
      });

      if (!response.ok) {
        throw new Error('Failed to update valve position');
      }

      toast.success(`Valve position set to ${valvePosition}%`);
    } catch (err) {
      setError(err.message);
      toast.error(`Failed to update valve position: ${err.message}`);
    } finally {
      setIsUpdating(false);
    }
  }, [valvePosition]);

  // Format remaining time
  const formatTime = (seconds) => {
    if (!seconds) return '';
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return html`
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        Manual Override
      </h2>

      <!-- Valve Position Slider -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Valve Position
        </label>

        <div class="relative mb-4">
          <input
            type="range"
            min="0"
            max="100"
            step="5"
            value=${valvePosition}
            onInput=${(e) => setValvePosition(parseInt(e.target.value))}
            disabled=${!overrideEnabled}
            class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
            style="background: linear-gradient(to right, #ff9800 0%, #ff9800 ${valvePosition}%, rgb(229 231 235) ${valvePosition}%, rgb(229 231 235) 100%)"
          />

          <!-- Floating Value Display -->
          ${overrideEnabled && html`
            <div
              class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-3 py-1 rounded-lg text-lg font-bold shadow-lg"
              style="left: ${valvePosition}%"
            >
              ${valvePosition}%
              <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-orange-500"></div>
            </div>
          `}
        </div>

        <!-- Min/Max Labels -->
        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-4">
          <span>0%</span>
          <span>100%</span>
        </div>
      </div>

      <!-- Toggle and Set Buttons -->
      <div class="space-y-2">
        <button
          onClick=${handleToggleOverride}
          disabled=${isUpdating}
          class="${overrideEnabled
            ? 'bg-red-500 hover:bg-red-600'
            : 'bg-orange-500 hover:bg-orange-600'
          } w-full px-4 py-3 disabled:bg-gray-400 text-white font-medium rounded-lg transition-all duration-200 shadow-md hover:shadow-lg disabled:cursor-not-allowed"
        >
          ${overrideEnabled ? 'Disable Manual Control' : 'Enable Manual Control'}
        </button>

        ${overrideEnabled && html`
          <button
            onClick=${handleSetValvePosition}
            disabled=${isUpdating}
            class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-all duration-200 disabled:cursor-not-allowed"
          >
            ${isUpdating ? 'Updating...' : 'Update Position'}
          </button>
        `}
      </div>

      <!-- Timer Display -->
      ${overrideEnabled && remainingTime && html`
        <div class="mt-3 p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg">
          <p class="text-sm text-orange-700 dark:text-orange-300 flex items-center gap-2">
            <span>⏱️</span>
            <span>Override active for ${formatTime(remainingTime)}</span>
          </p>
        </div>
      `}

      <!-- Error Display -->
      ${error && html`
        <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <p class="text-sm text-red-600 dark:text-red-400">${error}</p>
        </div>
      `}
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/Dashboard/SystemCard.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';

const html = htm.bind(h);

/**
 * SystemCard Component
 * System navigation and actions
 */
export function SystemCard() {
  const handleRefresh = () => {
    window.location.reload();
  };

  const navItems = [
    { label: 'Event Logs', href: '/logs' },
    { label: 'Serial Monitor', href: '/serial' },
    { label: 'Firmware Update', href: '/update' },
    { label: 'Configuration', href: '/config' },
    { label: 'System Status', href: '/status' },
  ];

  return html`
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        System
      </h2>

      <div class="space-y-2">
        <!-- Refresh Button -->
        <button
          onClick=${handleRefresh}
          class="w-full px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
        >
          Refresh Data
        </button>

        <!-- Navigation Links -->
        ${navItems.map(({ label, href }) => html`
          <a
            href=${href}
            class="block w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-medium rounded-lg transition-all duration-200 text-center shadow-sm hover:shadow-md"
          >
            ${label}
          </a>
        `)}
      </div>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/common/FactoryResetModal.jsx
################################################################################

import { h } from 'preact';
import { useState, useEffect } from 'preact/hooks';
import htm from 'htm';
import { Dialog } from '@headlessui/react';
import toast from '../../utils/toast.js';

const html = htm.bind(h);

const CONFIRMATION_TEXT = 'RESET';
const COUNTDOWN_SECONDS = 10;

/**
 * FactoryResetModal Component
 * Advanced confirmation modal for factory reset with type-to-confirm and countdown
 * Implements destructive action confirmation from PREACT_UX_IMPROVEMENTS.md
 *
 * @param {Object} props
 * @param {boolean} props.isOpen - Whether modal is open
 * @param {Function} props.onClose - Close handler
 * @param {Function} props.onConfirm - Confirm handler (async)
 */
export function FactoryResetModal({ isOpen, onClose, onConfirm }) {
  const [inputValue, setInputValue] = useState('');
  const [countdown, setCountdown] = useState(COUNTDOWN_SECONDS);
  const [isProcessing, setIsProcessing] = useState(false);

  // Reset state when modal opens/closes
  useEffect(() => {
    if (isOpen) {
      setInputValue('');
      setCountdown(COUNTDOWN_SECONDS);
      setIsProcessing(false);
    }
  }, [isOpen]);

  // Countdown timer
  useEffect(() => {
    if (!isOpen || countdown === 0) return;

    const interval = setInterval(() => {
      setCountdown(prev => Math.max(0, prev - 1));
    }, 1000);

    return () => clearInterval(interval);
  }, [isOpen, countdown]);

  const isConfirmEnabled =
    inputValue === CONFIRMATION_TEXT &&
    countdown === 0 &&
    !isProcessing;

  const handleConfirm = async () => {
    if (!isConfirmEnabled) return;

    setIsProcessing(true);

    try {
      await onConfirm();
      toast.success('Factory reset completed successfully');
      onClose();
    } catch (err) {
      toast.error(`Factory reset failed: ${err.message}`);
    } finally {
      setIsProcessing(false);
    }
  };

  return html`
    <${Dialog}
      open=${isOpen}
      onClose=${() => !isProcessing && onClose()}
      class="relative z-50"
    >
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" aria-hidden="true"></div>

      <!-- Full-screen container -->
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <!-- Modal panel -->
        <${Dialog.Panel} class="mx-auto max-w-lg w-full bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 animate-fade-in">
          <!-- Warning Icon -->
          <div class="bg-red-100 dark:bg-red-900/20 w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto">
            <span class="text-4xl">🚨</span>
          </div>

          <!-- Title -->
          <${Dialog.Title} class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-3">
            Factory Reset
          <//>

          <!-- Warning Message -->
          <div class="bg-red-50 dark:bg-red-900/10 border-2 border-red-200 dark:border-red-800 rounded-lg p-4 mb-4">
            <p class="text-red-800 dark:text-red-200 font-semibold mb-2">
              ⚠️ This action cannot be undone!
            </p>
            <p class="text-red-700 dark:text-red-300 text-sm">
              Factory reset will:
            </p>
            <ul class="text-red-700 dark:text-red-300 text-sm list-disc list-inside mt-2 space-y-1">
              <li>Delete all configuration settings</li>
              <li>Clear WiFi and MQTT credentials</li>
              <li>Reset PID parameters to defaults</li>
              <li>Clear all preset configurations</li>
              <li>Erase temperature history data</li>
            </ul>
          </div>

          <!-- Countdown Timer -->
          ${countdown > 0 && html`
            <div class="bg-orange-50 dark:bg-orange-900/10 border border-orange-200 dark:border-orange-800 rounded-lg p-3 mb-4 text-center">
              <p class="text-orange-700 dark:text-orange-300 font-medium">
                Please wait ${countdown} second${countdown !== 1 ? 's' : ''} before confirming...
              </p>
              <div class="mt-2 h-2 bg-orange-200 dark:bg-orange-800 rounded-full overflow-hidden">
                <div
                  class="h-full bg-orange-500 transition-all duration-1000 ease-linear"
                  style="width: ${((COUNTDOWN_SECONDS - countdown) / COUNTDOWN_SECONDS) * 100}%"
                ></div>
              </div>
            </div>
          `}

          <!-- Type-to-Confirm Input -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Type <span class="font-mono font-bold text-red-600 dark:text-red-400">${CONFIRMATION_TEXT}</span> to confirm:
            </label>
            <input
              type="text"
              value=${inputValue}
              onInput=${(e) => setInputValue(e.target.value.toUpperCase())}
              disabled=${isProcessing || countdown > 0}
              placeholder=${countdown > 0 ? 'Waiting for countdown...' : `Type "${CONFIRMATION_TEXT}"`}
              class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border-2 ${
                inputValue === CONFIRMATION_TEXT
                  ? 'border-red-500 dark:border-red-400'
                  : 'border-gray-300 dark:border-gray-600'
              } rounded-lg text-gray-900 dark:text-white font-mono font-bold text-center text-lg focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
            />
            ${inputValue && inputValue !== CONFIRMATION_TEXT && html`
              <p class="mt-2 text-sm text-red-600 dark:text-red-400">
                Text does not match. Please type exactly: ${CONFIRMATION_TEXT}
              </p>
            `}
            ${inputValue === CONFIRMATION_TEXT && countdown === 0 && html`
              <p class="mt-2 text-sm text-green-600 dark:text-green-400 flex items-center gap-1">
                <span>✓</span>
                <span>Confirmed. You may now proceed.</span>
              </p>
            `}
          </div>

          <!-- Actions -->
          <div class="flex gap-3">
            <button
              onClick=${onClose}
              disabled=${isProcessing}
              class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Cancel
            </button>
            <button
              onClick=${handleConfirm}
              disabled=${!isConfirmEnabled}
              class="flex-1 px-4 py-3 ${
                isConfirmEnabled
                  ? 'bg-red-500 hover:bg-red-600'
                  : 'bg-gray-400 dark:bg-gray-600'
              } text-white rounded-lg font-medium transition-colors disabled:cursor-not-allowed"
            >
              ${isProcessing ? 'Resetting...' : 'Factory Reset'}
            </button>
          </div>
        <//>
      </div>
    <//>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/common/ValidatedInput.jsx
################################################################################

import { h } from 'preact';
import { useState, useEffect } from 'preact/hooks';
import htm from 'htm';

const html = htm.bind(h);

/**
 * ValidatedInput Component
 * Input field with real-time validation feedback
 * Implements real-time form validation from PREACT_UX_IMPROVEMENTS.md
 *
 * @param {Object} props
 * @param {string} props.label - Input label
 * @param {string} props.value - Input value
 * @param {Function} props.onChange - Change handler
 * @param {Function} props.validator - Validation function (value) => { isValid, error }
 * @param {string} [props.type='text'] - Input type
 * @param {string} [props.step] - Step for number inputs
 * @param {string} [props.placeholder] - Placeholder text
 * @param {boolean} [props.required=false] - Whether field is required
 * @param {string} [props.helpText] - Help text shown below input
 */
export function ValidatedInput({
  label,
  value,
  onChange,
  validator,
  type = 'text',
  step,
  placeholder,
  required = false,
  helpText,
}) {
  const [touched, setTouched] = useState(false);
  const [validation, setValidation] = useState({ isValid: true, error: null });

  // Validate on value change
  useEffect(() => {
    if (validator && value !== '' && value !== null && value !== undefined) {
      const result = validator(value);
      setValidation(result);
    } else if (!required && (value === '' || value === null || value === undefined)) {
      // Empty is valid if not required
      setValidation({ isValid: true, error: null });
    }
  }, [value, validator, required]);

  const handleBlur = () => {
    setTouched(true);
  };

  const showError = touched && !validation.isValid;
  const showSuccess = touched && validation.isValid && value !== '' && value !== null;

  return html`
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        ${label}
        ${required && html`<span class="text-red-500 ml-1">*</span>`}
      </label>

      <div class="relative">
        <input
          type=${type}
          step=${step}
          value=${value}
          onInput=${(e) => onChange(e.target.value)}
          onBlur=${handleBlur}
          placeholder=${placeholder}
          class="${
            showError
              ? 'border-red-500 focus:ring-red-500'
              : showSuccess
              ? 'border-green-500 focus:ring-green-500'
              : 'border-gray-300 dark:border-gray-600 focus:ring-primary-500'
          } w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 transition-all"
        />

        <!-- Validation Icon -->
        ${showError && html`
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-red-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
          </div>
        `}
        ${showSuccess && html`
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
          </div>
        `}
      </div>

      <!-- Error Message -->
      ${showError && html`
        <p class="mt-1 text-sm text-red-600 dark:text-red-400 flex items-center gap-1">
          <span>⚠️</span>
          <span>${validation.error}</span>
        </p>
      `}

      <!-- Help Text -->
      ${helpText && !showError && html`
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          ${helpText}
        </p>
      `}
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/common/ErrorBoundary.jsx
################################################################################

import { h, Component } from 'preact';
import htm from 'htm';

const html = htm.bind(h);

/**
 * ErrorBoundary Component
 * Catches JavaScript errors in child components and displays fallback UI
 * Implements error boundaries from PREACT_UX_IMPROVEMENTS.md
 */
export class ErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null,
    };
  }

  componentDidCatch(error, errorInfo) {
    // Log error to console
    console.error('ErrorBoundary caught an error:', error, errorInfo);

    // Update state to display fallback UI
    this.setState({
      hasError: true,
      error,
      errorInfo,
    });

    // Optional: Send error to logging service
    // logErrorToService(error, errorInfo);
  }

  resetError = () => {
    this.setState({
      hasError: false,
      error: null,
      errorInfo: null,
    });
  };

  render({ children, fallback }, { hasError, error, errorInfo }) {
    if (hasError) {
      // Custom fallback UI if provided
      if (fallback) {
        return fallback({ error, errorInfo, reset: this.resetError });
      }

      // Default fallback UI
      return html`
        <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4">
          <div class="max-w-2xl w-full bg-white dark:bg-gray-800 rounded-xl shadow-xl p-8">
            <!-- Error Icon -->
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-20 h-20 bg-red-100 dark:bg-red-900/20 rounded-full mb-4">
                <span class="text-5xl">💥</span>
              </div>
              <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                Something Went Wrong
              </h1>
              <p class="text-gray-600 dark:text-gray-400">
                The application encountered an unexpected error.
              </p>
            </div>

            <!-- Error Details -->
            <div class="bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
              <h3 class="font-semibold text-red-800 dark:text-red-300 mb-2">
                Error Details:
              </h3>
              <p class="text-sm text-red-700 dark:text-red-400 font-mono break-all">
                ${error?.message || 'Unknown error'}
              </p>

              ${error?.stack && html`
                <details class="mt-3">
                  <summary class="cursor-pointer text-sm text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300">
                    Show stack trace
                  </summary>
                  <pre class="mt-2 text-xs text-red-700 dark:text-red-400 overflow-x-auto bg-red-100 dark:bg-red-900/20 p-3 rounded">
${error.stack}
                  </pre>
                </details>
              `}
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-3">
              <button
                onClick=${this.resetError}
                class="flex-1 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white font-medium rounded-lg transition-all shadow-md hover:shadow-lg"
              >
                🔄 Try Again
              </button>
              <button
                onClick=${() => window.location.reload()}
                class="flex-1 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition-all"
              >
                ↻ Reload Page
              </button>
              <a
                href="/"
                class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-medium rounded-lg text-center transition-all"
              >
                🏠 Go Home
              </a>
            </div>

            <!-- Help Text -->
            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
              <p class="text-sm text-blue-700 dark:text-blue-300">
                <strong>💡 Troubleshooting Tips:</strong>
              </p>
              <ul class="mt-2 text-sm text-blue-600 dark:text-blue-400 list-disc list-inside space-y-1">
                <li>Check your internet connection</li>
                <li>Clear browser cache and reload</li>
                <li>Ensure ESP32 device is powered on</li>
                <li>Check browser console for detailed errors</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    return children;
  }
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/common/Spinner.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';

const html = htm.bind(h);

/**
 * Spinner Component
 * Reusable loading spinner with different sizes and colors
 * Implements loading indicators from PREACT_UX_IMPROVEMENTS.md
 *
 * @param {Object} props
 * @param {'sm'|'md'|'lg'|'xl'} [props.size='md'] - Spinner size
 * @param {'primary'|'white'|'gray'} [props.color='primary'] - Spinner color
 * @param {string} [props.label] - Optional label text
 * @param {boolean} [props.fullscreen=false] - Whether to show fullscreen overlay
 */
export function Spinner({ size = 'md', color = 'primary', label, fullscreen = false }) {
  const sizes = {
    sm: 'w-4 h-4 border-2',
    md: 'w-8 h-8 border-2',
    lg: 'w-12 h-12 border-3',
    xl: 'w-16 h-16 border-4',
  };

  const colors = {
    primary: 'border-primary-500 border-t-transparent',
    white: 'border-white border-t-transparent',
    gray: 'border-gray-400 dark:border-gray-600 border-t-transparent',
  };

  const spinner = html`
    <div
      class="${sizes[size]} ${colors[color]} rounded-full animate-spin"
      role="status"
      aria-label=${label || 'Loading...'}
    ></div>
  `;

  if (fullscreen) {
    return html`
      <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 flex flex-col items-center gap-4">
          ${spinner}
          ${label && html`
            <p class="text-gray-700 dark:text-gray-300 font-medium">${label}</p>
          `}
        </div>
      </div>
    `;
  }

  if (label) {
    return html`
      <div class="flex items-center gap-3">
        ${spinner}
        <span class="text-gray-700 dark:text-gray-300">${label}</span>
      </div>
    `;
  }

  return spinner;
}

/**
 * LoadingOverlay Component
 * Full-screen loading overlay with message
 *
 * @param {Object} props
 * @param {string} [props.message='Loading...'] - Loading message
 */
export function LoadingOverlay({ message = 'Loading...' }) {
  return html`<${Spinner} size="lg" fullscreen=${true} label=${message} />`;
}

/**
 * InlineSpinner Component
 * Small inline spinner for buttons and compact spaces
 *
 * @param {Object} props
 * @param {string} [props.label] - Optional label
 */
export function InlineSpinner({ label }) {
  return html`<${Spinner} size="sm" color="white" label=${label} />`;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/common/ConfirmationModal.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';
import { Dialog } from '@headlessui/react';

const html = htm.bind(h);

/**
 * ConfirmationModal Component
 * Reusable confirmation dialog for dangerous actions
 * Implements modal confirmation from PREACT_UX_IMPROVEMENTS.md
 *
 * @param {Object} props
 * @param {boolean} props.isOpen - Whether modal is open
 * @param {Function} props.onClose - Close handler
 * @param {Function} props.onConfirm - Confirm handler
 * @param {string} props.title - Modal title
 * @param {string} props.message - Modal message
 * @param {string} [props.confirmText='Confirm'] - Confirm button text
 * @param {string} [props.cancelText='Cancel'] - Cancel button text
 * @param {'danger'|'warning'|'info'} [props.variant='danger'] - Visual variant
 * @param {boolean} [props.isLoading=false] - Loading state
 */
export function ConfirmationModal({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  confirmText = 'Confirm',
  cancelText = 'Cancel',
  variant = 'danger',
  isLoading = false,
}) {
  const variantStyles = {
    danger: {
      icon: '⚠️',
      iconBg: 'bg-red-100 dark:bg-red-900/20',
      iconText: 'text-red-600 dark:text-red-400',
      button: 'bg-red-500 hover:bg-red-600 focus:ring-red-500',
    },
    warning: {
      icon: '⚠️',
      iconBg: 'bg-orange-100 dark:bg-orange-900/20',
      iconText: 'text-orange-600 dark:text-orange-400',
      button: 'bg-orange-500 hover:bg-orange-600 focus:ring-orange-500',
    },
    info: {
      icon: 'ℹ️',
      iconBg: 'bg-blue-100 dark:bg-blue-900/20',
      iconText: 'text-blue-600 dark:text-blue-400',
      button: 'bg-blue-500 hover:bg-blue-600 focus:ring-blue-500',
    },
  };

  const style = variantStyles[variant];

  return html`
    <${Dialog}
      open=${isOpen}
      onClose=${onClose}
      class="relative z-50"
    >
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black/30 backdrop-blur-sm" aria-hidden="true"></div>

      <!-- Full-screen container -->
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <!-- Modal panel -->
        <${Dialog.Panel} class="mx-auto max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 animate-fade-in">
          <!-- Icon -->
          <div class="${style.iconBg} w-12 h-12 rounded-full flex items-center justify-center mb-4">
            <span class="text-2xl">${style.icon}</span>
          </div>

          <!-- Title -->
          <${Dialog.Title} class="text-xl font-bold text-gray-900 dark:text-white mb-2">
            ${title}
          <//>

          <!-- Message -->
          <${Dialog.Description} class="text-gray-600 dark:text-gray-400 mb-6">
            ${message}
          <//>

          <!-- Actions -->
          <div class="flex gap-3 justify-end">
            <button
              onClick=${onClose}
              disabled=${isLoading}
              class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ${cancelText}
            </button>
            <button
              onClick=${onConfirm}
              disabled=${isLoading}
              class="${style.button} px-4 py-2 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ${isLoading ? 'Processing...' : confirmText}
            </button>
          </div>
        <//>
      </div>
    <//>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/components/common/ConfigWizard.jsx
################################################################################

import { h } from 'preact';
import { useState } from 'preact/hooks';
import htm from 'htm';
import { ValidatedInput } from './ValidatedInput.jsx';
import { Spinner } from './Spinner.jsx';
import {
  validateSSID,
  validateBroker,
  validatePort,
  validatePID,
} from '../../utils/validation.js';
import toast from '../../utils/toast.js';

const html = htm.bind(h);

/**
 * ConfigWizard Component
 * Step-by-step configuration wizard for first-time setup
 * Steps: WiFi → MQTT → Sensors (PID) → Review & Save
 */
export function ConfigWizard({ isOpen, onClose, onComplete }) {
  const [currentStep, setCurrentStep] = useState(0);
  const [saving, setSaving] = useState(false);

  // WiFi configuration state
  const [wifiConfig, setWifiConfig] = useState({
    ssid: '',
    password: '',
  });

  // MQTT configuration state
  const [mqttConfig, setMqttConfig] = useState({
    broker: '',
    port: '1883',
    username: '',
    password: '',
  });

  // PID configuration state
  const [pidConfig, setPidConfig] = useState({
    kp: '2.0',
    ki: '0.5',
    kd: '1.0',
  });

  const steps = [
    { id: 'wifi', title: 'WiFi Setup' },
    { id: 'mqtt', title: 'MQTT Setup' },
    { id: 'sensors', title: 'Sensor Setup' },
    { id: 'review', title: 'Review & Save' },
  ];

  // Validation state for each step
  const isWifiValid = () => {
    const ssidValid = validateSSID(wifiConfig.ssid).isValid;
    const passwordValid = wifiConfig.password.length >= 8;
    return ssidValid && passwordValid;
  };

  const isMqttValid = () => {
    const brokerValid = validateBroker(mqttConfig.broker).isValid;
    const portValid = validatePort(mqttConfig.port).isValid;
    return brokerValid && portValid;
  };

  const isPidValid = () => {
    const kpValid = validatePID(pidConfig.kp, 'kp').isValid;
    const kiValid = validatePID(pidConfig.ki, 'ki').isValid;
    const kdValid = validatePID(pidConfig.kd, 'kd').isValid;
    return kpValid && kiValid && kdValid;
  };

  const canProceed = () => {
    switch (currentStep) {
      case 0:
        return isWifiValid();
      case 1:
        return isMqttValid();
      case 2:
        return isPidValid();
      case 3:
        return true; // Review step
      default:
        return false;
    }
  };

  const handleNext = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1);
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // Save WiFi configuration
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          section: 'wifi',
          ssid: wifiConfig.ssid,
          password: wifiConfig.password,
        }),
      });

      // Save MQTT configuration
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          section: 'mqtt',
          broker: mqttConfig.broker,
          port: parseInt(mqttConfig.port),
          username: mqttConfig.username,
          password: mqttConfig.password,
        }),
      });

      // Save PID configuration
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          section: 'pid',
          kp: parseFloat(pidConfig.kp),
          ki: parseFloat(pidConfig.ki),
          kd: parseFloat(pidConfig.kd),
        }),
      });

      toast.success('Configuration saved successfully!');
      setSaving(false);
      onComplete?.();
      onClose?.();
    } catch (err) {
      toast.error(`Failed to save configuration: ${err.message}`);
      setSaving(false);
    }
  };

  const handleSkip = () => {
    onClose?.();
  };

  if (!isOpen) return null;

  return html`
    <div class="fixed inset-0 z-50 overflow-y-auto">
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>

      <!-- Modal -->
      <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-3xl w-full p-8 animate-slideUp">
          <!-- Header -->
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
              Setup Wizard
            </h2>
            <p class="text-gray-600 dark:text-gray-400">
              Let's configure your ESP32 Thermostat step by step
            </p>
          </div>

          <!-- Progress Indicator -->
          <div class="mb-8">
            <div class="flex justify-between mb-4">
              ${steps.map(
                (step, index) => html`
                  <div
                    class="flex flex-col items-center flex-1"
                    key=${step.id}
                  >
                    <!-- Step Icon -->
                    <div
                      class="${index <= currentStep
                        ? 'bg-primary-500 text-white'
                        : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'}
                      w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold transition-all duration-300 mb-2"
                    >
                      ${index < currentStep
                        ? '✓'
                        : index + 1}
                    </div>
                    <!-- Step Title -->
                    <span
                      class="${index <= currentStep
                        ? 'text-gray-900 dark:text-white font-semibold'
                        : 'text-gray-500 dark:text-gray-400'}
                      text-sm text-center"
                    >
                      ${step.title}
                    </span>
                    <!-- Connector Line -->
                    ${index < steps.length - 1 &&
                    html`
                      <div
                        class="${index < currentStep
                          ? 'bg-primary-500'
                          : 'bg-gray-200 dark:bg-gray-700'}
                        h-1 w-full absolute top-6 left-1/2 -z-10 transition-all duration-300"
                        style="width: calc(100% / ${steps.length} - 3rem)"
                      ></div>
                    `}
                  </div>
                `
              )}
            </div>
          </div>

          <!-- Step Content -->
          <div class="mb-8 min-h-[400px]">
            ${currentStep === 0 && renderWifiStep()}
            ${currentStep === 1 && renderMqttStep()}
            ${currentStep === 2 && renderSensorsStep()}
            ${currentStep === 3 && renderReviewStep()}
          </div>

          <!-- Navigation Buttons -->
          <div class="flex justify-between items-center pt-6 border-t border-gray-200 dark:border-gray-700">
            <div>
              ${currentStep > 0 &&
              html`
                <button
                  onClick=${handleBack}
                  disabled=${saving}
                  class="px-6 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium transition-all disabled:opacity-50"
                >
                  ← Back
                </button>
              `}
            </div>

            <div class="flex gap-3">
              <button
                onClick=${handleSkip}
                disabled=${saving}
                class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white font-medium transition-all disabled:opacity-50"
              >
                Skip Setup
              </button>

              ${currentStep < steps.length - 1
                ? html`
                    <button
                      onClick=${handleNext}
                      disabled=${!canProceed() || saving}
                      class="px-6 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-all"
                    >
                      Next →
                    </button>
                  `
                : html`
                    <button
                      onClick=${handleSave}
                      disabled=${saving}
                      class="px-6 py-2 bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all flex items-center gap-2"
                    >
                      ${saving
                        ? html`<${Spinner} size="sm" color="white" />
                            <span>Saving...</span>`
                        : html`<span>Save Configuration</span>`}
                    </button>
                  `}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  // WiFi Setup Step
  function renderWifiStep() {
    return html`
      <div class="space-y-6 animate-fadeIn">
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <p class="text-sm text-blue-700 dark:text-blue-300">
            <strong>WiFi Setup:</strong> Configure your WiFi network credentials
            to connect your ESP32 to the internet. Make sure you're using a
            2.4GHz network as the ESP32 doesn't support 5GHz.
          </p>
        </div>

        <${ValidatedInput}
          label="WiFi Network Name (SSID)"
          type="text"
          value=${wifiConfig.ssid}
          onChange=${(value) => setWifiConfig({ ...wifiConfig, ssid: value })}
          validator=${validateSSID}
          placeholder="Enter your WiFi network name"
          required=${true}
          helpText="Maximum 32 characters"
        />

        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
          >
            WiFi Password
          </label>
          <input
            type="password"
            value=${wifiConfig.password}
            onInput=${(e) =>
              setWifiConfig({ ...wifiConfig, password: e.target.value })}
            class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border ${wifiConfig
              .password.length >= 8
              ? 'border-green-500'
              : wifiConfig.password.length > 0
              ? 'border-red-500'
              : 'border-gray-300 dark:border-gray-600'} rounded-lg text-gray-900 dark:text-white"
            placeholder="Enter WiFi password"
          />
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Minimum 8 characters
          </p>
          ${wifiConfig.password.length > 0 &&
          wifiConfig.password.length < 8 &&
          html`
            <p class="mt-1 text-xs text-red-600 dark:text-red-400">
              Password must be at least 8 characters
            </p>
          `}
        </div>
      </div>
    `;
  }

  // MQTT Setup Step
  function renderMqttStep() {
    return html`
      <div class="space-y-6 animate-fadeIn">
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <p class="text-sm text-blue-700 dark:text-blue-300">
            <strong>MQTT Setup:</strong> Configure your MQTT broker to enable
            communication with Home Assistant and other smart home platforms.
            You can skip this step if you don't use MQTT.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <${ValidatedInput}
              label="MQTT Broker Address"
              type="text"
              value=${mqttConfig.broker}
              onChange=${(value) =>
                setMqttConfig({ ...mqttConfig, broker: value })}
              validator=${validateBroker}
              placeholder="mqtt.example.com or 192.168.1.100"
              required=${true}
              helpText="Hostname or IP address of your MQTT broker"
            />
          </div>

          <${ValidatedInput}
            label="MQTT Port"
            type="number"
            value=${mqttConfig.port}
            onChange=${(value) => setMqttConfig({ ...mqttConfig, port: value })}
            validator=${validatePort}
            required=${true}
            helpText="Usually 1883 for MQTT"
          />

          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Username (Optional)
            </label>
            <input
              type="text"
              value=${mqttConfig.username}
              onInput=${(e) =>
                setMqttConfig({ ...mqttConfig, username: e.target.value })}
              class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
              placeholder="MQTT username"
            />
          </div>

          <div class="md:col-span-2">
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Password (Optional)
            </label>
            <input
              type="password"
              value=${mqttConfig.password}
              onInput=${(e) =>
                setMqttConfig({ ...mqttConfig, password: e.target.value })}
              class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
              placeholder="MQTT password"
            />
          </div>
        </div>
      </div>
    `;
  }

  // Sensors Setup Step
  function renderSensorsStep() {
    return html`
      <div class="space-y-6 animate-fadeIn">
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <p class="text-sm text-blue-700 dark:text-blue-300">
            <strong>PID Tuning:</strong> Configure the PID controller parameters
            for optimal temperature regulation. The default values work well for
            most setups, but you can fine-tune them later based on your specific
            radiator and room characteristics.
          </p>
        </div>

        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
          <p class="text-sm text-yellow-700 dark:text-yellow-300">
            <strong>Note:</strong> Kp controls proportional response, Ki reduces
            steady-state error, and Kd dampens oscillations. Start with default
            values and adjust if needed.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <${ValidatedInput}
            label="Kp (Proportional)"
            type="number"
            step="0.1"
            value=${pidConfig.kp}
            onChange=${(value) => setPidConfig({ ...pidConfig, kp: value })}
            validator=${(value) => validatePID(value, 'kp')}
            required=${true}
            helpText="Range: 0.1 - 100"
          />

          <${ValidatedInput}
            label="Ki (Integral)"
            type="number"
            step="0.01"
            value=${pidConfig.ki}
            onChange=${(value) => setPidConfig({ ...pidConfig, ki: value })}
            validator=${(value) => validatePID(value, 'ki')}
            required=${true}
            helpText="Range: 0 - 10"
          />

          <${ValidatedInput}
            label="Kd (Derivative)"
            type="number"
            step="0.01"
            value=${pidConfig.kd}
            onChange=${(value) => setPidConfig({ ...pidConfig, kd: value })}
            validator=${(value) => validatePID(value, 'kd')}
            required=${true}
            helpText="Range: 0 - 10"
          />
        </div>
      </div>
    `;
  }

  // Review & Save Step
  function renderReviewStep() {
    return html`
      <div class="space-y-6 animate-fadeIn">
        <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
          <p class="text-sm text-green-700 dark:text-green-300">
            <strong>Review Your Configuration:</strong> Please review your
            settings before saving. You can always change these later in the
            Configuration page.
          </p>
        </div>

        <!-- WiFi Configuration Review -->
        <div class="bg-white dark:bg-gray-700 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2"
          >
            <span>📡</span>
            <span>WiFi Configuration</span>
          </h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Network:</span>
              <span class="text-gray-900 dark:text-white font-medium"
                >${wifiConfig.ssid}</span
              >
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Password:</span>
              <span class="text-gray-900 dark:text-white font-medium"
                >${'•'.repeat(wifiConfig.password.length)}</span
              >
            </div>
          </div>
        </div>

        <!-- MQTT Configuration Review -->
        <div class="bg-white dark:bg-gray-700 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2"
          >
            <span>📨</span>
            <span>MQTT Configuration</span>
          </h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Broker:</span>
              <span class="text-gray-900 dark:text-white font-medium"
                >${mqttConfig.broker}:${mqttConfig.port}</span
              >
            </div>
            ${mqttConfig.username &&
            html`
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Username:</span>
                <span class="text-gray-900 dark:text-white font-medium"
                  >${mqttConfig.username}</span
                >
              </div>
            `}
          </div>
        </div>

        <!-- PID Configuration Review -->
        <div class="bg-white dark:bg-gray-700 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2"
          >
            <span>🎛️</span>
            <span>PID Configuration</span>
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            <div class="text-center">
              <div class="text-gray-600 dark:text-gray-400 text-sm mb-1">
                Kp
              </div>
              <div class="text-gray-900 dark:text-white font-bold text-xl">
                ${pidConfig.kp}
              </div>
            </div>
            <div class="text-center">
              <div class="text-gray-600 dark:text-gray-400 text-sm mb-1">
                Ki
              </div>
              <div class="text-gray-900 dark:text-white font-bold text-xl">
                ${pidConfig.ki}
              </div>
            </div>
            <div class="text-center">
              <div class="text-gray-600 dark:text-gray-400 text-sm mb-1">
                Kd
              </div>
              <div class="text-gray-900 dark:text-white font-bold text-xl">
                ${pidConfig.kd}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/hooks/useDarkMode.js
################################################################################

import { useState, useEffect } from 'preact/hooks';

/**
 * useDarkMode Hook
 * Manages dark mode state with localStorage persistence
 * Implements dark mode from PREACT_UX_IMPROVEMENTS.md
 */
export function useDarkMode() {
  // Check system preference or localStorage
  const [isDark, setIsDark] = useState(() => {
    // First check localStorage
    const stored = localStorage.getItem('darkMode');
    if (stored !== null) {
      return stored === 'true';
    }

    // Fall back to system preference
    if (window.matchMedia) {
      return window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    return false;
  });

  // Apply dark mode class to HTML element
  useEffect(() => {
    if (isDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }

    // Persist to localStorage
    localStorage.setItem('darkMode', isDark.toString());
  }, [isDark]);

  const toggle = () => setIsDark(!isDark);

  return { isDark, toggle };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/hooks/usePresets.js
################################################################################

import { useState, useEffect, useCallback } from 'preact/hooks';

/**
 * Custom hook for managing preset modes
 * Handles fetching, applying, and saving presets
 * Implements optimistic updates for instant UI feedback
 *
 * @returns {Object} { presetMode, presetConfig, applyPreset, loading, error }
 */
export function usePresets() {
  const [presetMode, setPresetMode] = useState('none');
  const [presetConfig, setPresetConfig] = useState({
    eco: 18.0,
    comfort: 22.0,
    away: 16.0,
    sleep: 19.0,
    boost: 24.0,
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Fetch preset configuration from API
  const fetchPresetConfig = useCallback(async (signal) => {
    try {
      const response = await fetch('/api/config', { signal });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();

      if (data.presets) {
        setPresetMode(data.presets.current || 'none');
        setPresetConfig({
          eco: data.presets.eco ?? 18.0,
          comfort: data.presets.comfort ?? 22.0,
          away: data.presets.away ?? 16.0,
          sleep: data.presets.sleep ?? 19.0,
          boost: data.presets.boost ?? 24.0,
        });
      }
      setError(null);
    } catch (err) {
      // Don't log AbortError as it's expected on unmount
      if (err.name === 'AbortError') {
        return;
      }
      console.error('Failed to fetch preset config:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  // Apply a preset mode (with optimistic update)
  const applyPreset = useCallback(async (mode) => {
    const previousMode = presetMode;

    // Optimistic update - update UI immediately
    setPresetMode(mode);

    try {
      // Get the temperature for this preset
      const temperature = presetConfig[mode];
      if (temperature == null) {
        throw new Error(`Invalid preset mode: ${mode}`);
      }

      // Use the /api/setpoint endpoint to set the temperature
      const response = await fetch('/api/setpoint', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `value=${temperature}`,
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      setError(null);
      return true;
    } catch (err) {
      console.error('Failed to apply preset:', err);

      // Rollback on error
      setPresetMode(previousMode);
      setError(err.message);

      return false;
    }
  }, [presetMode, presetConfig]);

  // Get temperature for a specific preset
  const getPresetTemperature = useCallback((mode) => {
    if (mode === 'none') return null;
    return presetConfig[mode] ?? null;
  }, [presetConfig]);

  useEffect(() => {
    const abortController = new AbortController();
    fetchPresetConfig(abortController.signal);

    return () => {
      abortController.abort();
    };
  }, []);

  return {
    presetMode,
    presetConfig,
    applyPreset,
    getPresetTemperature,
    loading,
    error,
    refetch: fetchPresetConfig,
  };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/hooks/useHistoryData.js
################################################################################

import { useState, useEffect } from 'preact/hooks';

/**
 * Custom hook for fetching and managing historical sensor data
 * Implements polling strategy from GRAPH_VISUALIZATION_REFACTOR.md
 *
 * @param {number} refreshInterval - Polling interval in ms (default 30000)
 * @returns {Object} { data, loading, error, refetch }
 */
export function useHistoryData(refreshInterval = 30000) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const fetchData = async (signal) => {
    try {
      const response = await fetch('/api/history?maxPoints=0', { signal });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const json = await response.json();

      // Validate data structure
      if (!json.timestamps || !json.temperatures) {
        throw new Error('Invalid data format received from API');
      }

      setData({
        timestamps: json.timestamps || [],
        temperatures: json.temperatures || [],
        humidities: json.humidities || [],
        pressures: json.pressures || [],
        valvePositions: json.valvePositions || [],
        count: json.timestamps?.length || 0,
      });
      setError(null);
    } catch (err) {
      // Don't log AbortError as it's expected on unmount
      if (err.name === 'AbortError') {
        return;
      }
      console.error('Failed to fetch history data:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    let isMounted = true;
    let timerId = null;
    let abortController = new AbortController();

    // Recursive polling pattern - only schedule next poll after current one completes
    const poll = async () => {
      await fetchData(abortController.signal);
      if (isMounted) {
        timerId = setTimeout(poll, refreshInterval);
      }
    };

    // Start initial poll
    poll();

    // Cleanup on unmount
    return () => {
      isMounted = false;
      abortController.abort();
      if (timerId) clearTimeout(timerId);
    };
  }, [refreshInterval]);

  return {
    data,
    loading,
    error,
    refetch: fetchData, // Allow manual refresh
  };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/hooks/useSensorData.js
################################################################################

import { useState, useEffect, useCallback } from 'preact/hooks';

/**
 * Custom hook for fetching real-time sensor data
 * Implements polling with error handling and recovery
 *
 * @param {number} refreshInterval - Polling interval in ms (default 5000)
 * @returns {Object} { data, loading, error, refetch }
 */
export function useSensorData(refreshInterval = 5000) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const fetchData = useCallback(async (signal) => {
    try {
      const response = await fetch('/api/sensor', { signal });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const json = await response.json();

      setData({
        temperature: json.temperature ?? 0,
        humidity: json.humidity ?? 0,
        pressure: json.pressure ?? 0,
        valve: json.valve ?? 0,
        setpoint: json.setpoint ?? 22.0,
      });
      setError(null);
    } catch (err) {
      // Don't log AbortError as it's expected on unmount
      if (err.name === 'AbortError') {
        return;
      }
      console.error('Failed to fetch sensor data:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    let isMounted = true;
    let timerId = null;
    let abortController = new AbortController();

    // Recursive polling pattern - only schedule next poll after current one completes
    const poll = async () => {
      await fetchData(abortController.signal);
      if (isMounted) {
        timerId = setTimeout(poll, refreshInterval);
      }
    };

    // Start initial poll
    poll();

    // Cleanup on unmount
    return () => {
      isMounted = false;
      abortController.abort();
      if (timerId) clearTimeout(timerId);
    };
  }, [refreshInterval, fetchData]);

  return {
    data,
    loading,
    error,
    refetch: fetchData,
  };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/hooks/useSystemInfo.js
################################################################################

import { useState, useEffect } from 'preact/hooks';

/**
 * Custom hook for fetching system information (version, uptime, etc.)
 * Fetches once on mount - system info doesn't change frequently
 *
 * @returns {Object} { version, loading, error }
 */
export function useSystemInfo() {
  const [version, setVersion] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const abortController = new AbortController();

    async function fetchSystemInfo() {
      try {
        const response = await fetch('/api/status', { signal: abortController.signal });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const json = await response.json();
        setVersion(json.system?.firmware_version ?? 'Unknown');
        setError(null);
      } catch (err) {
        if (err.name === 'AbortError') {
          return;
        }
        console.error('Failed to fetch system info:', err);
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }

    fetchSystemInfo();

    return () => {
      abortController.abort();
    };
  }, []);

  return {
    version,
    loading,
    error,
  };
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/pages/Status.jsx
################################################################################

import { h } from 'preact';
import { useState, useEffect } from 'preact/hooks';
import htm from 'htm';

const html = htm.bind(h);

/**
 * Status Page
 * Displays ESP32 system status information
 */
export function Status() {
  const [status, setStatus] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchStatus();
    const interval = setInterval(fetchStatus, 10000); // Update every 10s
    return () => clearInterval(interval);
  }, []);

  const fetchStatus = async () => {
    try {
      const response = await fetch('/api/status');
      const data = await response.json();
      setStatus(data);
      setLoading(false);
    } catch (err) {
      setError(err.message);
      setLoading(false);
    }
  };

  if (loading) {
    return html`
      <div class="space-y-6">
        ${[...Array(3)].map(() => html`
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-pulse">
            <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-32 mb-4"></div>
            <div class="space-y-3">
              ${[...Array(4)].map(() => html`
                <div class="flex justify-between">
                  <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-24"></div>
                  <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-32"></div>
                </div>
              `)}
            </div>
          </div>
        `)}
      </div>
    `;
  }

  if (error) {
    return html`
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="text-center py-8">
          <div class="text-red-500 text-5xl mb-4">⚠️</div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
            Failed to Load Status
          </h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">${error}</p>
          <button
            onClick=${fetchStatus}
            class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600"
          >
            Retry
          </button>
        </div>
      </div>
    `;
  }

  // Helper function to format duration
  const formatDuration = (seconds) => {
    if (!seconds) return '--';
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    if (days > 0) return `${days}d ${hours}h ${minutes}m`;
    if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
    if (minutes > 0) return `${minutes}m ${secs}s`;
    return `${secs}s`;
  };

  // Helper function to format interval (ms to readable)
  const formatInterval = (ms) => {
    if (!ms) return '--';
    if (ms < 1000) return `${ms}ms`;
    if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
    if (ms < 3600000) return `${(ms / 60000).toFixed(1)}min`;
    return `${(ms / 3600000).toFixed(1)}h`;
  };

  return html`
    <div class="space-y-6">
      <!-- System Information -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          System Information
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${[
            { label: 'Uptime', value: formatDuration(status?.system?.uptime) },
            { label: 'Free Heap', value: status?.system?.free_heap ? `${(status.system.free_heap / 1024).toFixed(1)} KB` : '--' },
            { label: 'Total Heap', value: status?.system?.total_heap ? `${(status.system.total_heap / 1024).toFixed(1)} KB` : '--' },
            { label: 'Chip Model', value: status?.system?.chip_model || '--' },
            { label: 'CPU Frequency', value: status?.system?.cpu_freq_mhz ? `${status.system.cpu_freq_mhz} MHz` : '--' },
            { label: 'Free Flash', value: status?.system?.free_flash_kb ? `${status.system.free_flash_kb} KB` : '--' },
          ].map(({ label, value }) => html`
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              <span class="text-gray-600 dark:text-gray-400">${label}</span>
              <span class="font-semibold text-gray-900 dark:text-white">${value}</span>
            </div>
          `)}
        </div>
      </div>

      <!-- Network Information -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          Network Status
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${[
            { label: 'WiFi SSID', value: status?.wifi?.ssid || '--' },
            { label: 'IP Address', value: status?.wifi?.ip || '--' },
            { label: 'Signal Strength', value: status?.wifi?.rssi ? `${status.wifi.rssi} dBm` : '--' },
            { label: 'Signal Quality', value: status?.wifi?.quality ? `${status.wifi.quality}%` : '--' },
            { label: 'MAC Address', value: status?.wifi?.mac || '--' },
            { label: 'Connected', value: status?.wifi?.connected ? '✅ Yes' : '❌ No' },
          ].map(({ label, value }) => html`
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              <span class="text-gray-600 dark:text-gray-400">${label}</span>
              <span class="font-semibold text-gray-900 dark:text-white font-mono text-sm">${value}</span>
            </div>
          `)}
        </div>
      </div>

      <!-- MQTT Status -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          MQTT Configuration
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${[
            { label: 'Server', value: status?.mqtt?.server || '--' },
            { label: 'Port', value: status?.mqtt?.port || '--' },
          ].map(({ label, value }) => html`
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              <span class="text-gray-600 dark:text-gray-400">${label}</span>
              <span class="font-semibold text-gray-900 dark:text-white font-mono text-sm">${value}</span>
            </div>
          `)}
        </div>
      </div>

      <!-- Timing Intervals -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          Timing Intervals
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${[
            { label: 'Sensor Update', value: formatInterval(status?.timing?.sensor_update_interval) },
            { label: 'History Update', value: formatInterval(status?.timing?.history_update_interval) },
            { label: 'PID Update', value: formatInterval(status?.timing?.pid_update_interval) },
            { label: 'Connectivity Check', value: formatInterval(status?.timing?.connectivity_check_interval) },
            { label: 'PID Config Write', value: formatInterval(status?.timing?.pid_config_write_interval) },
            { label: 'WiFi Connect Timeout', value: status?.timing?.wifi_connect_timeout ? `${status.timing.wifi_connect_timeout}s` : '--' },
            { label: 'Max Reconnect Attempts', value: status?.timing?.max_reconnect_attempts || '--' },
            { label: 'System Watchdog', value: formatInterval(status?.timing?.system_watchdog_timeout) },
            { label: 'WiFi Watchdog', value: formatInterval(status?.timing?.wifi_watchdog_timeout) },
          ].map(({ label, value }) => html`
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              <span class="text-gray-600 dark:text-gray-400">${label}</span>
              <span class="font-semibold text-gray-900 dark:text-white">${value}</span>
            </div>
          `)}
        </div>
      </div>

      <!-- PID Configuration -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          PID Configuration
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${[
            { label: 'Kp', value: status?.pid?.kp?.toFixed(3) || '--' },
            { label: 'Ki', value: status?.pid?.ki?.toFixed(3) || '--' },
            { label: 'Kd', value: status?.pid?.kd?.toFixed(3) || '--' },
            { label: 'Setpoint', value: status?.pid?.setpoint ? `${status.pid.setpoint.toFixed(1)}°C` : '--' },
            { label: 'Deadband', value: status?.pid?.deadband ? `${status.pid.deadband.toFixed(2)}°C` : '--' },
            { label: 'Valve Position', value: status?.pid?.valve_position !== undefined ? `${status.pid.valve_position}%` : '--' },
            { label: 'Adaptation Interval', value: status?.pid?.adaptation_interval ? `${status.pid.adaptation_interval}s` : '--' },
          ].map(({ label, value }) => html`
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              <span class="text-gray-600 dark:text-gray-400">${label}</span>
              <span class="font-semibold text-gray-900 dark:text-white">${value}</span>
            </div>
          `)}
        </div>
      </div>

      <!-- Presets -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          Temperature Presets
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${[
            { label: 'Current Preset', value: status?.presets?.current || '--' },
            { label: 'Eco', value: status?.presets?.eco ? `${status.presets.eco.toFixed(1)}°C` : '--' },
            { label: 'Comfort', value: status?.presets?.comfort ? `${status.presets.comfort.toFixed(1)}°C` : '--' },
            { label: 'Away', value: status?.presets?.away ? `${status.presets.away.toFixed(1)}°C` : '--' },
            { label: 'Sleep', value: status?.presets?.sleep ? `${status.presets.sleep.toFixed(1)}°C` : '--' },
            { label: 'Boost', value: status?.presets?.boost ? `${status.presets.boost.toFixed(1)}°C` : '--' },
          ].map(({ label, value }) => html`
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              <span class="text-gray-600 dark:text-gray-400">${label}</span>
              <span class="font-semibold text-gray-900 dark:text-white">${value}</span>
            </div>
          `)}
        </div>
      </div>

      <!-- Diagnostics -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          Diagnostics
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${[
            { label: 'Last Reboot Reason', value: status?.diagnostics?.last_reboot_reason || '--' },
            { label: 'Reboot Count', value: status?.diagnostics?.reboot_count || '--' },
            { label: 'Watchdog Reboots', value: status?.diagnostics?.consecutive_watchdog_reboots || '--' },
          ].map(({ label, value }) => html`
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              <span class="text-gray-600 dark:text-gray-400">${label}</span>
              <span class="font-semibold text-gray-900 dark:text-white">${value}</span>
            </div>
          `)}
        </div>
      </div>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/pages/Dashboard.jsx
################################################################################

import { h } from 'preact';
import htm from 'htm';
import { GraphContainer } from '../components/Graph/GraphContainer.jsx';
import { SensorCard } from '../components/Dashboard/SensorCard.jsx';
import { ControlCard } from '../components/Dashboard/ControlCard.jsx';
import { ManualOverrideCard } from '../components/Dashboard/ManualOverrideCard.jsx';
import { SystemCard } from '../components/Dashboard/SystemCard.jsx';

const html = htm.bind(h);

/**
 * Dashboard Page
 * Main landing page showing sensor data, controls, and history graph
 * Implements skeleton loading from PREACT_UX_IMPROVEMENTS.md
 */
export function Dashboard() {
  return html`
    <div class="page-enter">
      <!-- Two-column layout on desktop, stacked on mobile -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 stagger-children">
        <!-- Left Column: Sensor Readings -->
        <div class="space-y-6">
          <${SensorCard} />
        </div>

        <!-- Right Column: Controls -->
        <div class="space-y-6">
          <${ControlCard} />
          <${ManualOverrideCard} />
          <${SystemCard} />
        </div>
      </div>

      <!-- Full-width Graph Section -->
      <div class="mt-6 slide-in-right">
        <${GraphContainer} />
      </div>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/pages/Logs.jsx
################################################################################

import { h } from 'preact';
import { useState, useEffect } from 'preact/hooks';
import htm from 'htm';

const html = htm.bind(h);

/**
 * Logs Page
 * Displays event logs from the ESP32
 */
export function Logs() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [filter, setFilter] = useState('all'); // all, info, warning, error

  useEffect(() => {
    fetchLogs();
    const interval = setInterval(fetchLogs, 5000); // Update every 5s
    return () => clearInterval(interval);
  }, []);

  const fetchLogs = async () => {
    try {
      const response = await fetch('/api/logs');
      const data = await response.json();
      setLogs(data.logs || []);
      setLoading(false);
    } catch (err) {
      setError(err.message);
      setLoading(false);
    }
  };

  const clearLogs = async () => {
    try {
      await fetch('/api/logs', { method: 'DELETE' });
      setLogs([]);
    } catch (err) {
      setError(err.message);
    }
  };

  const filteredLogs = filter === 'all'
    ? logs
    : logs.filter(log => log.level === filter);

  const getLevelStyle = (level) => {
    switch (level) {
      case 'error':
        return {
          bg: 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800',
          text: 'text-red-700 dark:text-red-300',
          icon: '❌',
        };
      case 'warning':
        return {
          bg: 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800',
          text: 'text-orange-700 dark:text-orange-300',
          icon: '⚠️',
        };
      case 'info':
      default:
        return {
          bg: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800',
          text: 'text-blue-700 dark:text-blue-300',
          icon: 'ℹ️',
        };
    }
  };

  if (loading) {
    return html`
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="animate-pulse space-y-4">
          <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-32"></div>
          ${[...Array(5)].map(() => html`
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
              <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full"></div>
              <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-24 mt-2"></div>
            </div>
          `)}
        </div>
      </div>
    `;
  }

  return html`
    <div class="space-y-4">
      <!-- Header with Filters and Actions -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <!-- Filter Buttons -->
          <div class="flex gap-2 flex-wrap">
            ${[
              { value: 'all', label: 'All', icon: '📋' },
              { value: 'info', label: 'Info', icon: 'ℹ️' },
              { value: 'warning', label: 'Warning', icon: '⚠️' },
              { value: 'error', label: 'Error', icon: '❌' },
            ].map(({ value, label, icon }) => html`
              <button
                key=${value}
                onClick=${() => setFilter(value)}
                class="${filter === value
                  ? 'bg-primary-500 text-white'
                  : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
                } px-3 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-md flex items-center gap-1"
              >
                <span>${icon}</span>
                <span>${label}</span>
              </button>
            `)}
          </div>

          <!-- Actions -->
          <div class="flex gap-2">
            <button
              onClick=${fetchLogs}
              class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-all"
            >
              🔄 Refresh
            </button>
            <button
              onClick=${clearLogs}
              class="px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-all"
            >
              🗑️ Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Logs List -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
          Event Logs (${filteredLogs.length})
        </h2>

        ${error && html`
          <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
            <p class="text-red-600 dark:text-red-400">${error}</p>
          </div>
        `}

        ${filteredLogs.length === 0 ? html`
          <div class="text-center py-12">
            <div class="text-gray-400 text-5xl mb-4">📋</div>
            <p class="text-gray-600 dark:text-gray-400">No logs available</p>
          </div>
        ` : html`
          <div class="space-y-2 max-h-[400px] sm:max-h-[600px] overflow-y-auto">
            ${filteredLogs.map((log, index) => {
              const style = getLevelStyle(log.level);
              return html`
                <div
                  key=${index}
                  class="${style.bg} border ${style.text} rounded-lg p-4 transition-all hover:shadow-md"
                >
                  <div class="flex items-start gap-3">
                    <span class="text-xl flex-shrink-0">${style.icon}</span>
                    <div class="flex-1 min-w-0">
                      <p class="font-mono text-sm break-words">${log.message}</p>
                      <p class="text-xs opacity-70 mt-1">
                        ${log.timestamp || new Date().toLocaleString()}
                      </p>
                    </div>
                  </div>
                </div>
              `;
            })}
          </div>
        `}
      </div>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/pages/Serial.jsx
################################################################################

import { h } from 'preact';
import { useState, useEffect, useRef } from 'preact/hooks';
import htm from 'htm';

const html = htm.bind(h);

/**
 * Serial Monitor Page
 * Real-time serial output from ESP32
 */
export function Serial() {
  const [lines, setLines] = useState([]);
  const [isConnected, setIsConnected] = useState(false);
  const [autoscroll, setAutoscroll] = useState(true);
  const scrollRef = useRef(null);
  const wsRef = useRef(null);

  useEffect(() => {
    // Connect to WebSocket for real-time serial output
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/serial`;
    
    const ws = new WebSocket(wsUrl);
    wsRef.current = ws;

    ws.onopen = () => {
      setIsConnected(true);
      setLines([]); // Clear on reconnect
    };

    ws.onmessage = (event) => {
      const line = event.data;
      if (line && line.trim()) {
        setLines(prev => [...prev, line].slice(-500)); // Keep last 500 lines
      }
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      setIsConnected(false);
    };

    ws.onclose = () => {
      setIsConnected(false);
      // Attempt to reconnect after 3 seconds
      setTimeout(() => {
        if (wsRef.current?.readyState === WebSocket.CLOSED) {
          // Reconnect logic handled by useEffect cleanup/re-run
        }
      }, 3000);
    };

    return () => {
      if (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING) {
        ws.close();
      }
    };
  }, []);

  // Auto-scroll to bottom
  useEffect(() => {
    if (autoscroll && scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [lines, autoscroll]);

  const clearOutput = () => {
    setLines([]);
  };

  return html`
    <div class="space-y-4">
      <!-- Header with Controls -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <!-- Connection Status -->
          <div class="flex items-center gap-3">
            <div class="${isConnected
              ? 'bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300'
              : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
            } px-3 py-2 rounded-lg font-medium flex items-center gap-2">
              <div class="${isConnected ? 'bg-green-500' : 'bg-gray-500'} w-2 h-2 rounded-full animate-pulse"></div>
              <span>${isConnected ? 'Connected' : 'Disconnected'}</span>
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
              ${lines.length} lines
            </div>
          </div>

          <!-- Controls -->
          <div class="flex gap-2">
            <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">
              <input
                type="checkbox"
                checked=${autoscroll}
                onChange=${(e) => setAutoscroll(e.target.checked)}
                class="rounded"
              />
              <span>Auto-scroll</span>
            </label>
            <button
              onClick=${clearOutput}
              class="px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-all"
            >
              🗑️ Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Serial Output -->
      <div class="bg-gray-900 dark:bg-black rounded-xl shadow-lg p-4 font-mono text-sm">
        <div
          ref=${scrollRef}
          class="h-[300px] sm:h-[400px] md:h-[600px] overflow-y-auto text-green-400 leading-relaxed"
        >
          ${lines.length === 0 ? html`
            <div class="text-center text-gray-500 py-12">
              <p>Waiting for serial output...</p>
              <p class="text-xs mt-2 opacity-70">Output will appear here when available</p>
            </div>
          ` : lines.map((line, index) => html`
            <div key=${index} class="hover:bg-gray-800/50 px-2 py-1">
              <span class="text-gray-600 select-none">${(index + 1).toString().padStart(4, '0')}</span>
              <span class="ml-3">${line}</span>
            </div>
          `)}
        </div>
      </div>

      <!-- Info Card -->
      <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div class="flex gap-3">
          <span class="text-blue-500 text-2xl flex-shrink-0">ℹ️</span>
          <div class="text-blue-700 dark:text-blue-300 text-sm">
            <p class="font-semibold mb-1">Serial Monitor Tips:</p>
            <ul class="list-disc list-inside space-y-1">
              <li>Real-time serial output via WebSocket</li>
              <li>Maximum 500 lines are kept in memory</li>
              <li>Disable auto-scroll to review previous output</li>
              <li>Use Clear to remove all lines</li>
              <li>Reconnects automatically if connection is lost</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  `;
}


################################################################################
## /Users/hermanhello/Documents/trae/ESP32-KNX-Thermostat/frontend/src/pages/Config.jsx
################################################################################

import { h } from 'preact';
import { useState, useEffect } from 'preact/hooks';
import htm from 'htm';
import { FactoryResetModal } from '../components/common/FactoryResetModal.jsx';
import { ConfigWizard } from '../components/common/ConfigWizard.jsx';
import { ValidatedInput } from '../components/common/ValidatedInput.jsx';
import { validatePID } from '../utils/validation.js';
import toast from '../utils/toast.js';

const html = htm.bind(h);

/**
 * Config Page
 * Complete configuration settings matching main branch functionality
 */
export function Config() {
  const [config, setConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [activeTab, setActiveTab] = useState('network');
  const [showResetModal, setShowResetModal] = useState(false);
  const [showWizard, setShowWizard] = useState(false);

  // Form state
  const [formData, setFormData] = useState({});

  // PID parameter state with validation
  const [pidValues, setPidValues] = useState({
    kp: '2.0',
    ki: '0.5',
    kd: '1.0',
    setpoint: '22.0',
    deadband: '0.5',
    adaptation_enabled: true,
    adaptation_interval: '60',
  });
  const [pidValid, setPidValid] = useState({
    kp: true,
    ki: true,
    kd: true,
    setpoint: true,
    deadband: true,
    adaptation_interval: true,
  });

  useEffect(() => {
    fetchConfig();
  }, []);

  // Update form state when config loads
  useEffect(() => {
    if (config) {
      setFormData({
        wifi_ssid: config.network?.wifi_ssid || '',
        wifi_pass: '',
        ntp_server: config.network?.ntp_server || 'pool.ntp.org',
        ntp_timezone_offset: config.network?.ntp_timezone_offset || 0,
        ntp_daylight_offset: config.network?.ntp_daylight_offset || 0,
        mqtt_server: config.mqtt?.server || '',
        mqtt_port: config.mqtt?.port || 1883,
        mqtt_username: config.mqtt?.username || '',
        mqtt_password: '',
        mqtt_json_aggregate_enabled: config.mqtt?.json_aggregate_enabled || false,
        knx_area: config.knx?.area || 0,
        knx_line: config.knx?.line || 0,
        knx_member: config.knx?.member || 0,
        knx_test: config.knx?.use_test || false,
        knx_valve_cmd_area: config.knx?.valve_command?.area || 0,
        knx_valve_cmd_line: config.knx?.valve_command?.line || 0,
        knx_valve_cmd_member: config.knx?.valve_command?.member || 0,
        knx_valve_fb_area: config.knx?.valve_feedback?.area || 0,
        knx_valve_fb_line: config.knx?.valve_feedback?.line || 0,
        knx_valve_fb_member: config.knx?.valve_feedback?.member || 0,
        bme280_address: config.bme280?.address || '0x76',
        bme280_sda: config.bme280?.sda_pin || 21,
        bme280_scl: config.bme280?.scl_pin || 22,
        bme280_interval: config.bme280?.interval || 30,
        preset_eco: config.presets?.eco || 18.0,
        preset_comfort: config.presets?.comfort || 22.0,
        preset_away: config.presets?.away || 16.0,
        preset_sleep: config.presets?.sleep || 19.0,
        preset_boost: config.presets?.boost || 24.0,
        sensor_update_interval: config.timing?.sensor_update_interval || 30000,
        history_update_interval: config.timing?.history_update_interval || 30000,
        pid_update_interval: config.timing?.pid_update_interval || 10000,
        connectivity_check_interval: config.timing?.connectivity_check_interval || 300000,
        pid_config_write_interval: config.timing?.pid_config_write_interval || 300000,
        wifi_connect_timeout: config.timing?.wifi_connect_timeout || 180,
        system_watchdog_timeout: config.timing?.system_watchdog_timeout || 2700000,
        wifi_watchdog_timeout: config.timing?.wifi_watchdog_timeout || 1800000,
        max_reconnect_attempts: config.timing?.max_reconnect_attempts || 10,
        webhook_enabled: config.webhook?.enabled || false,
        webhook_url: config.webhook?.url || '',
        webhook_temp_low: config.webhook?.temp_low_threshold || 15.0,
        webhook_temp_high: config.webhook?.temp_high_threshold || 30.0,
      });

      if (config.pid) {
        setPidValues({
          kp: config.pid.kp?.toString() || '2.0',
          ki: config.pid.ki?.toString() || '0.5',
          kd: config.pid.kd?.toString() || '1.0',
          setpoint: config.pid.setpoint?.toString() || '22.0',
          deadband: config.pid.deadband?.toString() || '0.5',
          adaptation_enabled: config.pid.adaptation_enabled ?? true,
          adaptation_interval: config.pid.adaptation_interval?.toString() || '60',
        });
      }
    }
  }, [config]);

  const fetchConfig = async () => {
    try {
      const response = await fetch('/api/config');
      const data = await response.json();
      setConfig(data);
      setLoading(false);
    } catch (err) {
      toast.error(`Failed to load config: ${err.message}`);
      setLoading(false);
    }
  };

  const updateFormData = (key, value) => {
    setFormData(prev => ({ ...prev, [key]: value }));
  };

  const saveConfig = async (section, values) => {
    setSaving(true);
    try {
      const response = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [section]: values }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save configuration');
      }

      toast.success('Configuration saved successfully');
      await fetchConfig(); // Refresh config
    } catch (err) {
      toast.error(`Failed to save config: ${err.message}`);
    } finally {
      setSaving(false);
    }
  };

  // Handle PID value changes
  const handlePidChange = (param, value) => {
    setPidValues(prev => ({ ...prev, [param]: value }));
    const validation = validatePID(value, param);
    setPidValid(prev => ({ ...prev, [param]: validation.isValid }));
  };

  // Save PID configuration
  const savePidConfig = async () => {
    const allValid = Object.values(pidValid).every(v => v);
    if (!allValid) {
      toast.error('Please fix validation errors before saving');
      return;
    }

    await saveConfig('pid', {
      kp: parseFloat(pidValues.kp),
      ki: parseFloat(pidValues.ki),
      kd: parseFloat(pidValues.kd),
      setpoint: parseFloat(pidValues.setpoint),
      deadband: parseFloat(pidValues.deadband),
      adaptation_enabled: pidValues.adaptation_enabled,
      adaptation_interval: parseFloat(pidValues.adaptation_interval),
    });
  };

  const isPidFormValid = Object.values(pidValid).every(v => v);

  const handleFactoryReset = async () => {
    try {
      const response = await fetch('/api/factory-reset', { method: 'POST' });
      if (!response.ok) throw new Error('Factory reset failed');
      toast.info('Device is resetting... Please wait.');
      setTimeout(() => {
        window.location.reload();
      }, 5000);
    } catch (err) {
      toast.error(`Factory reset failed: ${err.message}`);
    }
  };

  const handleReboot = async () => {
    try {
      const response = await fetch('/api/reboot', { method: 'POST' });
      if (!response.ok) throw new Error('Reboot failed');
      toast.info('Device is rebooting... Please wait.');
      setTimeout(() => {
        window.location.reload();
      }, 5000);
    } catch (err) {
      toast.error(`Reboot failed: ${err.message}`);
    }
  };

  const handleExportConfig = async () => {
    try {
      const response = await fetch('/api/config/export');
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `thermostat-config-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      toast.success('Configuration exported');
    } catch (err) {
      toast.error(`Export failed: ${err.message}`);
    }
  };

  const handleImportConfig = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const json = JSON.parse(text);
        const response = await fetch('/api/config/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: text,
        });

        if (!response.ok) throw new Error('Import failed');
        toast.success('Configuration imported successfully');
        await fetchConfig();
      } catch (err) {
        toast.error(`Import failed: ${err.message}`);
      }
    };
    input.click();
  };

  const testWebhook = async () => {
    try {
      const response = await fetch('/api/webhook/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: formData.webhook_url,
          temp_low: formData.webhook_temp_low,
          temp_high: formData.webhook_temp_high,
        }),
      });

      if (!response.ok) throw new Error('Webhook test failed');
      toast.success('Webhook test sent successfully');
    } catch (err) {
      toast.error(`Webhook test failed: ${err.message}`);
    }
  };

  if (loading) {
    return html`
      <div class="space-y-6">
        ${[...Array(4)].map(() => html`
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-pulse">
            <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-40 mb-4"></div>
            <div class="space-y-3">
              ${[...Array(3)].map(() => html`
                <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded"></div>
              `)}
            </div>
          </div>
        `)}
      </div>
    `;
  }

  const tabs = [
    { id: 'network', label: 'Network' },
    { id: 'mqtt', label: 'MQTT' },
    { id: 'knx', label: 'KNX' },
    { id: 'bme280', label: 'BME280' },
    { id: 'pid', label: 'PID' },
    { id: 'presets', label: 'Presets' },
    { id: 'timing', label: 'Timing' },
    { id: 'webhook', label: 'Webhook' },
  ];

  return html`
    <div class="space-y-6">
      <!-- Getting Started Section -->
      <div class="bg-gradient-to-r from-primary-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold mb-2 flex items-center gap-2">
              <span>🚀</span>
              <span>Getting Started</span>
            </h2>
            <p class="text-white/90">
              New to the ESP32 Thermostat? Use our setup wizard to configure your device step-by-step.
            </p>
          </div>
          <button
            onClick=${() => setShowWizard(true)}
            class="px-6 py-3 bg-white text-primary-600 hover:bg-gray-100 rounded-lg font-semibold transition-all flex items-center gap-2 whitespace-nowrap self-start md:self-center"
          >
            <span>✨</span>
            <span>Launch Setup Wizard</span>
          </button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
        <div class="flex flex-wrap gap-2">
          ${tabs.map(tab => html`
            <button
              onClick=${() => setActiveTab(tab.id)}
              class="px-4 py-2 rounded-lg font-medium transition-all ${
                activeTab === tab.id
                  ? 'bg-primary-500 text-white'
                  : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
              }"
            >
              ${tab.label}
            </button>
          `)}
        </div>
      </div>

      <!-- Network Tab -->
      ${activeTab === 'network' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>📡</span>
            <span>Network Configuration</span>
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                WiFi SSID
              </label>
              <input
                type="text"
                value=${formData.wifi_ssid || ''}
                onInput=${(e) => updateFormData('wifi_ssid', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                placeholder="Enter WiFi SSID"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                WiFi Password
              </label>
              <input
                type="password"
                autocomplete="current-password"
                value=${formData.wifi_pass || ''}
                onInput=${(e) => updateFormData('wifi_pass', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                placeholder="Leave empty to keep current password"
              />
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">NTP Time Synchronization</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    NTP Server
                  </label>
                  <input
                    type="text"
                    value=${formData.ntp_server || 'pool.ntp.org'}
                    onInput=${(e) => updateFormData('ntp_server', e.target.value)}
                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                    placeholder="pool.ntp.org"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Timezone Offset (seconds)
                  </label>
                  <input
                    type="number"
                    value=${formData.ntp_timezone_offset || 0}
                    onInput=${(e) => updateFormData('ntp_timezone_offset', parseInt(e.target.value))}
                    step="3600"
                    min="-43200"
                    max="43200"
                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                  />
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    UTC offset in seconds (e.g., UTC+1 = 3600, UTC+2 = 7200, UTC-5 = -18000)
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Daylight Saving Offset (seconds)
                  </label>
                  <input
                    type="number"
                    value=${formData.ntp_daylight_offset || 0}
                    onInput=${(e) => updateFormData('ntp_daylight_offset', parseInt(e.target.value))}
                    step="3600"
                    min="0"
                    max="7200"
                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                  />
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    DST offset in seconds (typically 3600 for 1 hour, 0 = no DST)
                  </p>
                </div>
              </div>
            </div>
            <button
              onClick=${() => saveConfig('network', {
                wifi_ssid: formData.wifi_ssid,
                wifi_pass: formData.wifi_pass || undefined,
                ntp_server: formData.ntp_server,
                ntp_timezone_offset: formData.ntp_timezone_offset,
                ntp_daylight_offset: formData.ntp_daylight_offset,
              })}
              disabled=${saving}
              class="px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
            >
              ${saving ? 'Saving...' : 'Save Network Settings'}
            </button>
          </div>
        </div>
      `}

      <!-- MQTT Tab -->
      ${activeTab === 'mqtt' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>📨</span>
            <span>MQTT Configuration</span>
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Broker Address
              </label>
              <input
                type="text"
                value=${formData.mqtt_server || ''}
                onInput=${(e) => updateFormData('mqtt_server', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                placeholder="mqtt.example.com"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Port
              </label>
              <input
                type="number"
                value=${formData.mqtt_port || 1883}
                onInput=${(e) => updateFormData('mqtt_port', parseInt(e.target.value))}
                min="1"
                max="65535"
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Username
              </label>
              <input
                type="text"
                value=${formData.mqtt_username || ''}
                onInput=${(e) => updateFormData('mqtt_username', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                placeholder="Leave empty for no authentication"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Password
              </label>
              <input
                type="password"
                autocomplete="current-password"
                value=${formData.mqtt_password || ''}
                onInput=${(e) => updateFormData('mqtt_password', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                placeholder="Leave empty to keep current password"
              />
            </div>
          </div>
          <div class="mt-4 flex items-center gap-3">
            <input
              type="checkbox"
              id="mqtt_json_aggregate_enabled"
              checked=${formData.mqtt_json_aggregate_enabled || false}
              onChange=${(e) => updateFormData('mqtt_json_aggregate_enabled', e.target.checked)}
              class="w-4 h-4 rounded"
            />
            <label for="mqtt_json_aggregate_enabled" class="text-sm font-medium text-gray-700 dark:text-gray-300">
              Enable JSON Aggregate
            </label>
            <span class="text-xs text-gray-500 dark:text-gray-400">
              Publish all data as JSON on 'telegraph' topic
            </span>
          </div>
          <button
            onClick=${() => saveConfig('mqtt', {
              server: formData.mqtt_server,
              port: formData.mqtt_port,
              username: formData.mqtt_username || undefined,
              password: formData.mqtt_password || undefined,
              json_aggregate_enabled: formData.mqtt_json_aggregate_enabled,
            })}
            disabled=${saving}
            class="mt-4 px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
          >
            ${saving ? 'Saving...' : 'Save MQTT Settings'}
          </button>
        </div>
      `}

      <!-- KNX Tab -->
      ${activeTab === 'knx' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>🏠</span>
            <span>KNX Configuration</span>
          </h2>
          <div class="space-y-6">
            <div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Physical Address</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Area</label>
                  <input
                    type="number"
                    value=${formData.knx_area || 0}
                    onInput=${(e) => updateFormData('knx_area', parseInt(e.target.value))}
                    min="0"
                    max="15"
                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Line</label>
                  <input
                    type="number"
                    value=${formData.knx_line || 0}
                    onInput=${(e) => updateFormData('knx_line', parseInt(e.target.value))}
                    min="0"
                    max="15"
                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Member</label>
                  <input
                    type="number"
                    value=${formData.knx_member || 0}
                    onInput=${(e) => updateFormData('knx_member', parseInt(e.target.value))}
                    min="0"
                    max="255"
                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                  />
                </div>
              </div>
            </div>
            <div>
              <div class="flex items-center gap-3 mb-4">
                <input
                  type="checkbox"
                  id="knx_test"
                  checked=${formData.knx_test || false}
                  onChange=${(e) => updateFormData('knx_test', e.target.checked)}
                  class="w-4 h-4 rounded"
                />
                <label for="knx_test" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  Use Test Addresses
                </label>
              </div>
              ${formData.knx_test && html`
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                  <p class="text-sm text-yellow-800 dark:text-yellow-300">
                    <strong>Active Test Addresses:</strong> Valve Command/Feedback: 10/2/2
                  </p>
                </div>
              `}
              ${!formData.knx_test && html`
                <div class="space-y-4">
                  <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 dark:text-blue-300 mb-3">Valve Command Address</h4>
                    <div class="grid grid-cols-3 gap-3">
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Area</label>
                        <input
                          type="number"
                          value=${formData.knx_valve_cmd_area || 0}
                          onInput=${(e) => updateFormData('knx_valve_cmd_area', parseInt(e.target.value))}
                          min="0"
                          max="15"
                          class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-gray-900 dark:text-white text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Line</label>
                        <input
                          type="number"
                          value=${formData.knx_valve_cmd_line || 0}
                          onInput=${(e) => updateFormData('knx_valve_cmd_line', parseInt(e.target.value))}
                          min="0"
                          max="15"
                          class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-gray-900 dark:text-white text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Member</label>
                        <input
                          type="number"
                          value=${formData.knx_valve_cmd_member || 0}
                          onInput=${(e) => updateFormData('knx_valve_cmd_member', parseInt(e.target.value))}
                          min="0"
                          max="255"
                          class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-gray-900 dark:text-white text-sm"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 dark:text-green-300 mb-3">Valve Feedback Address</h4>
                    <div class="grid grid-cols-3 gap-3">
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Area</label>
                        <input
                          type="number"
                          value=${formData.knx_valve_fb_area || 0}
                          onInput=${(e) => updateFormData('knx_valve_fb_area', parseInt(e.target.value))}
                          min="0"
                          max="15"
                          class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-gray-900 dark:text-white text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Line</label>
                        <input
                          type="number"
                          value=${formData.knx_valve_fb_line || 0}
                          onInput=${(e) => updateFormData('knx_valve_fb_line', parseInt(e.target.value))}
                          min="0"
                          max="15"
                          class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-gray-900 dark:text-white text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Member</label>
                        <input
                          type="number"
                          value=${formData.knx_valve_fb_member || 0}
                          onInput=${(e) => updateFormData('knx_valve_fb_member', parseInt(e.target.value))}
                          min="0"
                          max="255"
                          class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-gray-900 dark:text-white text-sm"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              `}
            </div>
            <button
              onClick=${() => saveConfig('knx', {
                area: formData.knx_area,
                line: formData.knx_line,
                member: formData.knx_member,
                use_test: formData.knx_test,
                valve_command: {
                  area: formData.knx_valve_cmd_area,
                  line: formData.knx_valve_cmd_line,
                  member: formData.knx_valve_cmd_member,
                },
                valve_feedback: {
                  area: formData.knx_valve_fb_area,
                  line: formData.knx_valve_fb_line,
                  member: formData.knx_valve_fb_member,
                },
              })}
              disabled=${saving}
              class="px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
            >
              ${saving ? 'Saving...' : 'Save KNX Settings'}
            </button>
          </div>
        </div>
      `}

      <!-- BME280 Tab -->
      ${activeTab === 'bme280' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>🌡️</span>
            <span>BME280 Sensor Configuration</span>
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                I²C Address
              </label>
              <select
                value=${formData.bme280_address || '0x76'}
                onInput=${(e) => updateFormData('bme280_address', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
              >
                <option value="0x76">0x76 (default)</option>
                <option value="0x77">0x77</option>
              </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  SDA Pin
                </label>
                <input
                  type="number"
                  value=${formData.bme280_sda || 21}
                  onInput=${(e) => updateFormData('bme280_sda', parseInt(e.target.value))}
                  min="0"
                  max="39"
                  class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  SCL Pin
                </label>
                <input
                  type="number"
                  value=${formData.bme280_scl || 22}
                  onInput=${(e) => updateFormData('bme280_scl', parseInt(e.target.value))}
                  min="0"
                  max="39"
                  class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Update Interval (seconds)
              </label>
              <input
                type="number"
                value=${formData.bme280_interval || 30}
                onInput=${(e) => updateFormData('bme280_interval', parseInt(e.target.value))}
                min="1"
                max="3600"
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
              />
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Seconds between sensor readings (1-3600)
              </p>
            </div>
            <button
              onClick=${() => saveConfig('bme280', {
                address: formData.bme280_address,
                sda_pin: formData.bme280_sda,
                scl_pin: formData.bme280_scl,
                interval: formData.bme280_interval,
              })}
              disabled=${saving}
              class="px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
            >
              ${saving ? 'Saving...' : 'Save BME280 Settings'}
            </button>
          </div>
        </div>
      `}

      <!-- PID Tab -->
      ${activeTab === 'pid' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>🎛️</span>
            <span>PID Configuration</span>
          </h2>
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-700 dark:text-blue-300">
              <strong>PID Tuning Guide:</strong> Kp controls proportional response, Ki reduces steady-state error, and Kd dampens oscillations. Adjust carefully for optimal temperature control.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <${ValidatedInput}
              label="Kp (Proportional)"
              type="number"
              step="0.1"
              value=${pidValues.kp}
              onChange=${(value) => handlePidChange('kp', value)}
              validator=${(value) => validatePID(value, 'kp')}
              helpText="Range: 0.1 - 100"
              required=${true}
            />
            <${ValidatedInput}
              label="Ki (Integral)"
              type="number"
              step="0.01"
              value=${pidValues.ki}
              onChange=${(value) => handlePidChange('ki', value)}
              validator=${(value) => validatePID(value, 'ki')}
              helpText="Range: 0 - 10"
              required=${true}
            />
            <${ValidatedInput}
              label="Kd (Derivative)"
              type="number"
              step="0.01"
              value=${pidValues.kd}
              onChange=${(value) => handlePidChange('kd', value)}
              validator=${(value) => validatePID(value, 'kd')}
              helpText="Range: 0 - 10"
              required=${true}
            />
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Default Setpoint (°C)
              </label>
              <input
                type="number"
                step="0.5"
                min="5"
                max="30"
                value=${pidValues.setpoint}
                onInput=${(e) => handlePidChange('setpoint', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Deadband (°C)
              </label>
              <input
                type="number"
                step="0.1"
                min="0"
                max="5"
                value=${pidValues.deadband}
                onInput=${(e) => handlePidChange('deadband', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
              />
            </div>
          </div>

          <!-- Adaptation Settings -->
          <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">Auto-Tuning & Adaptation</h4>

            <div class="mb-4">
              <label class="flex items-center gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  checked=${pidValues.adaptation_enabled}
                  onChange=${(e) => setPidValues({ ...pidValues, adaptation_enabled: e.target.checked })}
                  class="w-5 h-5 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                />
                <div>
                  <span class="text-sm font-medium text-gray-900 dark:text-white">
                    Enable Continuous Adaptation
                  </span>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Automatically adjusts PID parameters based on system performance. Disable for manual calibration.
                  </p>
                </div>
              </label>
            </div>

            ${pidValues.adaptation_enabled && html`
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Adaptation Interval (seconds)
                </label>
                <input
                  type="number"
                  step="1"
                  min="10"
                  max="600"
                  value=${pidValues.adaptation_interval}
                  onInput=${(e) => handlePidChange('adaptation_interval', e.target.value)}
                  class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  How often the system re-evaluates and adjusts PID parameters (10-600 seconds)
                </p>
              </div>
            `}
          </div>

          <div class="flex items-center gap-3">
            <button
              onClick=${savePidConfig}
              disabled=${saving || !isPidFormValid}
              class="px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-all"
            >
              ${saving ? 'Saving...' : 'Save PID Settings'}
            </button>
            ${!isPidFormValid && html`
              <span class="text-sm text-red-600 dark:text-red-400 flex items-center gap-1">
                <span>⚠️</span>
                <span>Please fix validation errors</span>
              </span>
            `}
          </div>
        </div>
      `}

      <!-- Presets Tab -->
      ${activeTab === 'presets' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>🌡️</span>
            <span>Temperature Presets</span>
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mb-6">
            Configure the temperature for each preset mode. These presets can be quickly selected from the dashboard.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${[
              { key: 'preset_eco', label: 'Eco Temperature', hint: 'Energy-saving temperature (typically 16-18°C)' },
              { key: 'preset_comfort', label: 'Comfort Temperature', hint: 'Comfortable temperature (typically 20-22°C)' },
              { key: 'preset_away', label: 'Away Temperature', hint: 'Temperature when away (typically 16-17°C)' },
              { key: 'preset_sleep', label: 'Sleep Temperature', hint: 'Nighttime temperature (typically 18-19°C)' },
              { key: 'preset_boost', label: 'Boost Temperature', hint: 'Quick heating temperature (typically 23-24°C)' },
            ].map(({ key, label, hint }) => html`
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  ${label} (°C)
                </label>
                <input
                  type="number"
                  step="0.5"
                  min="5"
                  max="30"
                  value=${formData[key] || ''}
                  onInput=${(e) => updateFormData(key, parseFloat(e.target.value))}
                  class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${hint}</p>
              </div>
            `)}
          </div>
          <button
            onClick=${() => saveConfig('presets', {
              eco: formData.preset_eco,
              comfort: formData.preset_comfort,
              away: formData.preset_away,
              sleep: formData.preset_sleep,
              boost: formData.preset_boost,
            })}
            disabled=${saving}
            class="mt-4 px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
          >
            ${saving ? 'Saving...' : 'Save Preset Settings'}
          </button>
        </div>
      `}

      <!-- Timing Tab -->
      ${activeTab === 'timing' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>⏱️</span>
            <span>Timing Intervals</span>
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mb-6">
            Configure how often the system updates sensor data, history, PID calculations, and performs connectivity checks.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${[
              { key: 'sensor_update_interval', label: 'Sensor Update Interval', unit: 'ms', min: 1000, max: 300000, hint: 'How often to read sensor (1s - 5min)' },
              { key: 'history_update_interval', label: 'History Update Interval', unit: 'ms', min: 1000, max: 300000, hint: 'How often to save history (1s - 5min)' },
              { key: 'pid_update_interval', label: 'PID Update Interval', unit: 'ms', min: 1000, max: 60000, hint: 'How often to calculate PID (1s - 1min)' },
              { key: 'connectivity_check_interval', label: 'Connectivity Check Interval', unit: 'ms', min: 60000, max: 3600000, hint: 'How often to check connectivity (1min - 1hr)' },
              { key: 'pid_config_write_interval', label: 'PID Config Write Interval', unit: 'ms', min: 60000, max: 3600000, hint: 'How often to save PID config (1min - 1hr)' },
              { key: 'wifi_connect_timeout', label: 'WiFi Connect Timeout', unit: 's', min: 10, max: 600, hint: 'WiFi connection timeout (10s - 10min)' },
              { key: 'system_watchdog_timeout', label: 'System Watchdog Timeout', unit: 'ms', min: 60000, max: 7200000, hint: 'System watchdog timeout (1min - 2hr)' },
              { key: 'wifi_watchdog_timeout', label: 'WiFi Watchdog Timeout', unit: 'ms', min: 60000, max: 7200000, hint: 'WiFi watchdog timeout (1min - 2hr)' },
              { key: 'max_reconnect_attempts', label: 'Max Reconnect Attempts', unit: '', min: 1, max: 100, hint: 'Maximum WiFi reconnection attempts' },
            ].map(({ key, label, unit, min, max, hint }) => html`
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  ${label}${unit ? ` (${unit})` : ''}
                </label>
                <input
                  type="number"
                  value=${formData[key] || ''}
                  onInput=${(e) => updateFormData(key, parseInt(e.target.value))}
                  min=${min}
                  max=${max}
                  class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${hint}</p>
              </div>
            `)}
          </div>
          <button
            onClick=${() => saveConfig('timing', {
              sensor_update_interval: formData.sensor_update_interval,
              history_update_interval: formData.history_update_interval,
              pid_update_interval: formData.pid_update_interval,
              connectivity_check_interval: formData.connectivity_check_interval,
              pid_config_write_interval: formData.pid_config_write_interval,
              wifi_connect_timeout: formData.wifi_connect_timeout,
              system_watchdog_timeout: formData.system_watchdog_timeout,
              wifi_watchdog_timeout: formData.wifi_watchdog_timeout,
              max_reconnect_attempts: formData.max_reconnect_attempts,
            })}
            disabled=${saving}
            class="mt-4 px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
          >
            ${saving ? 'Saving...' : 'Save Timing Settings'}
          </button>
        </div>
      `}

      <!-- Webhook Tab -->
      ${activeTab === 'webhook' && html`
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span>🔔</span>
            <span>Webhook Configuration</span>
          </h2>
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <input
                type="checkbox"
                id="webhook_enabled"
                checked=${formData.webhook_enabled || false}
                onChange=${(e) => updateFormData('webhook_enabled', e.target.checked)}
                class="w-4 h-4 rounded"
              />
              <label for="webhook_enabled" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                Enable Webhook
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Webhook URL
              </label>
              <input
                type="url"
                value=${formData.webhook_url || ''}
                onInput=${(e) => updateFormData('webhook_url', e.target.value)}
                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                placeholder="https://maker.ifttt.com/trigger/event/with/key/YOUR_KEY"
              />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Low Temperature Threshold (°C)
                </label>
                <input
                  type="number"
                  step="0.5"
                  min="-20"
                  max="50"
                  value=${formData.webhook_temp_low || 15.0}
                  onInput=${(e) => updateFormData('webhook_temp_low', parseFloat(e.target.value))}
                  class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  High Temperature Threshold (°C)
                </label>
                <input
                  type="number"
                  step="0.5"
                  min="-20"
                  max="50"
                  value=${formData.webhook_temp_high || 30.0}
                  onInput=${(e) => updateFormData('webhook_temp_high', parseFloat(e.target.value))}
                  class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"
                />
              </div>
            </div>
            <div class="flex gap-3">
              <button
                onClick=${() => saveConfig('webhook', {
                  enabled: formData.webhook_enabled,
                  url: formData.webhook_url,
                  temp_low_threshold: formData.webhook_temp_low,
                  temp_high_threshold: formData.webhook_temp_high,
                })}
                disabled=${saving}
                class="px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
              >
                ${saving ? 'Saving...' : 'Save Webhook Settings'}
              </button>
              <button
                onClick=${testWebhook}
                disabled=${!formData.webhook_url}
                class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-400 text-white rounded-lg font-medium transition-all"
              >
                Test Webhook
              </button>
            </div>
          </div>
        </div>
      `}

      <!-- Actions Bar -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <span>⚙️</span>
          <span>Device Actions</span>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button
            onClick=${handleExportConfig}
            class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2"
          >
            <span>📥</span>
            <span>Export Configuration</span>
          </button>
          <button
            onClick=${handleImportConfig}
            class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2"
          >
            <span>📤</span>
            <span>Import Configuration</span>
          </button>
          <button
            onClick=${handleReboot}
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2"
          >
            <span>🔄</span>
            <span>Reboot Device</span>
          </button>
          <button
            onClick=${() => setShowResetModal(true)}
            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2"
          >
            <span>⚠️</span>
            <span>Factory Reset</span>
          </button>
        </div>
      </div>

      <!-- Factory Reset Modal -->
      <${FactoryResetModal}
        isOpen=${showResetModal}
        onClose=${() => setShowResetModal(false)}
        onConfirm=${handleFactoryReset}
      />

      <!-- Configuration Wizard -->
      <${ConfigWizard}
        isOpen=${showWizard}
        onClose=${() => setShowWizard(false)}
        onComplete=${() => {
          setShowWizard(false);
          fetchConfig();
        }}
      />
    </div>
  `;
}


