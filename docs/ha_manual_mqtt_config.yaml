# =============================================================================
# Manual MQTT Configuration for Home Assistant
# =============================================================================
# Add this to your Home Assistant configuration.yaml file
#
# This bypasses MQTT discovery and manually defines the ESP32 thermostat
# Use this if MQTT discovery continues to have issues with preset modes
#
# INSTALLATION:
# 1. Copy the entire mqtt: section below into your configuration.yaml
# 2. If you already have an mqtt: section, merge the climate/sensor entries
# 3. Restart Home Assistant
# 4. The climate entity and sensors will appear after restart
# =============================================================================

mqtt:
  # Climate entity (thermostat with preset support)
  climate:
    - name: "ESP32 KNX Thermostat"
      unique_id: esp32_thermostat_climate_manual

      # Current temperature from BME280 sensor
      current_temperature_topic: "esp32_thermostat/temperature"

      # Target temperature (setpoint)
      temperature_command_topic: "esp32_thermostat/temperature/set"
      temperature_state_topic: "esp32_thermostat/temperature/setpoint"

      # HVAC Mode (off/heat)
      mode_command_topic: "esp32_thermostat/mode/set"
      mode_state_topic: "esp32_thermostat/mode/state"
      modes:
        - "off"
        - "heat"

      # Preset modes (eco, comfort, away, sleep, boost)
      preset_mode_command_topic: "esp32_thermostat/preset/set"
      preset_mode_state_topic: "esp32_thermostat/preset/state"
      preset_modes:
        - eco
        - comfort
        - away
        - sleep
        - boost

      # Temperature range and precision
      min_temp: 15
      max_temp: 30
      temp_step: 0.5
      precision: 0.5
      temperature_unit: "C"

      # NOTE: action_topic is not supported in manual YAML config
      # Action state is derived automatically from mode and temperature

      # Availability
      availability:
        - topic: "esp32_thermostat/status"
          payload_available: "online"
          payload_not_available: "offline"

      # Device info (groups all entities together)
      device:
        identifiers:
          - esp32_thermostat
        name: "ESP32 KNX Thermostat"
        manufacturer: "DIY"
        model: "ESP32-KNX-Thermostat"
        sw_version: "1.3"

  # Sensor entities
  sensor:
    # Temperature sensor
    - name: "ESP32 Temperature"
      unique_id: esp32_thermostat_temp_manual
      state_topic: "esp32_thermostat/temperature"
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement
      availability:
        - topic: "esp32_thermostat/status"
          payload_available: "online"
          payload_not_available: "offline"
      device:
        identifiers:
          - esp32_thermostat

    # Humidity sensor
    - name: "ESP32 Humidity"
      unique_id: esp32_thermostat_humidity_manual
      state_topic: "esp32_thermostat/humidity"
      unit_of_measurement: "%"
      device_class: humidity
      state_class: measurement
      availability:
        - topic: "esp32_thermostat/status"
          payload_available: "online"
          payload_not_available: "offline"
      device:
        identifiers:
          - esp32_thermostat

    # Pressure sensor
    - name: "ESP32 Pressure"
      unique_id: esp32_thermostat_pressure_manual
      state_topic: "esp32_thermostat/pressure"
      unit_of_measurement: "hPa"
      device_class: pressure
      state_class: measurement
      availability:
        - topic: "esp32_thermostat/status"
          payload_available: "online"
          payload_not_available: "offline"
      device:
        identifiers:
          - esp32_thermostat

    # Valve position sensor
    - name: "ESP32 Valve Position"
      unique_id: esp32_thermostat_valve_manual
      state_topic: "esp32_thermostat/valve/position"
      unit_of_measurement: "%"
      icon: "mdi:valve"
      state_class: measurement
      availability:
        - topic: "esp32_thermostat/status"
          payload_available: "online"
          payload_not_available: "offline"
      device:
        identifiers:
          - esp32_thermostat

    # Temperature setpoint sensor (for display)
    - name: "ESP32 Temperature Setpoint"
      unique_id: esp32_thermostat_setpoint_manual
      state_topic: "esp32_thermostat/temperature/setpoint"
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement
      availability:
        - topic: "esp32_thermostat/status"
          payload_available: "online"
          payload_not_available: "offline"
      device:
        identifiers:
          - esp32_thermostat

# =============================================================================
# NOTES:
# =============================================================================
# 1. This configuration bypasses MQTT discovery entirely
# 2. All entities will appear immediately after HA restart
# 3. Make sure ESP32 is publishing to the correct topics (esp32_thermostat/...)
# 4. Preset modes work perfectly with manual YAML configuration
# 5. To remove these entities, delete this config and restart HA
#
# TESTING:
# 1. Add config to configuration.yaml
# 2. Developer Tools → YAML → Check Configuration
# 3. If valid, restart Home Assistant
# 4. Check Settings → Devices & Services → MQTT
# 5. Look for "ESP32 KNX Thermostat" device with climate entity
# =============================================================================
