<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e88e5">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">

    <title>Serial Monitor - ESP32 KNX Thermostat</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .terminal-container {
            background-color: #1e1e1e;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            line-height: 1.4;
            height: 600px;
            min-height: 600px;
            overflow-y: auto;
            color: #d4d4d4;
        }

        .terminal-line {
            margin: 2px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .terminal-line.error {
            color: #f48771;
        }

        .terminal-line.warning {
            color: #dcdcaa;
        }

        .terminal-line.info {
            color: #4ec9b0;
        }

        .terminal-line.debug {
            color: #9cdcfe;
        }

        .terminal-timestamp {
            color: #6a9955;
            margin-right: 8px;
        }

        .terminal-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .terminal-controls button {
            min-width: 120px;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
        }

        .connection-status.connected {
            background-color: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background-color: #e74c3c;
            color: white;
        }

        .connection-status.connecting {
            background-color: #f39c12;
            color: white;
        }

        .filter-checkbox {
            margin-left: 5px;
        }

        .filter-label {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            color: #2c3e50;
            font-size: 14px;
        }

        .auto-scroll-indicator {
            color: #7f8c8d;
            font-size: 12px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header>
        <h1>Serial Monitor</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2 class="card-title">Live Serial Output</h2>

            <div class="terminal-controls">
                <span class="connection-status connecting" id="ws-status">Connecting...</span>
                <button id="clear-terminal">Clear</button>
                <button id="pause-scroll">Pause Auto-Scroll</button>
                <button id="download-log">Download Log</button>

                <div style="margin-left: auto; display: flex; gap: 15px; align-items: center;">
                    <label class="filter-label">
                        <input type="checkbox" class="filter-checkbox" id="filter-error" checked>
                        Errors
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" class="filter-checkbox" id="filter-warning" checked>
                        Warnings
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" class="filter-checkbox" id="filter-info" checked>
                        Info
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" class="filter-checkbox" id="filter-debug" checked>
                        Debug
                    </label>
                </div>
            </div>

            <div class="terminal-container" id="terminal">
                <div class="terminal-line">Waiting for serial data...</div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Navigation</h2>
            <div class="control-row">
                <a href="/"><button>Dashboard</button></a>
            </div>
            <div class="control-row">
                <a href="/logs.html"><button>Event Logs</button></a>
            </div>
            <div class="control-row">
                <a href="/config.html"><button>Configuration</button></a>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let autoScroll = true;
        let terminalBuffer = [];
        const MAX_LINES = 500;

        const terminal = document.getElementById('terminal');
        const statusEl = document.getElementById('ws-status');
        const pauseBtn = document.getElementById('pause-scroll');

        // Filter checkboxes
        const filters = {
            error: document.getElementById('filter-error'),
            warning: document.getElementById('filter-warning'),
            info: document.getElementById('filter-info'),
            debug: document.getElementById('filter-debug')
        };

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/serial`;

            statusEl.textContent = 'Connecting...';
            statusEl.className = 'connection-status connecting';

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.className = 'connection-status connected';
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                addLine(event.data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                statusEl.textContent = 'Error';
                statusEl.className = 'connection-status disconnected';
            };

            ws.onclose = () => {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'connection-status disconnected';
                console.log('WebSocket disconnected, reconnecting in 3s...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function addLine(line) {
            // Determine line type based on content
            let lineType = 'info';
            if (line.includes('ERROR') || line.includes('E |')) {
                lineType = 'error';
            } else if (line.includes('WARN') || line.includes('W |')) {
                lineType = 'warning';
            } else if (line.includes('DEBUG') || line.includes('D |')) {
                lineType = 'debug';
            }

            // Check if filtered
            if (!filters[lineType].checked) {
                return;
            }

            // Add to buffer
            terminalBuffer.push({ text: line, type: lineType });
            if (terminalBuffer.length > MAX_LINES) {
                terminalBuffer.shift();
            }

            // Add to terminal
            const lineEl = document.createElement('div');
            lineEl.className = `terminal-line ${lineType}`;
            lineEl.textContent = line;
            terminal.appendChild(lineEl);

            // Remove old lines
            while (terminal.children.length > MAX_LINES) {
                terminal.removeChild(terminal.firstChild);
            }

            // Auto-scroll
            if (autoScroll) {
                terminal.scrollTop = terminal.scrollHeight;
            }
        }

        function clearTerminal() {
            terminal.innerHTML = '<div class="terminal-line">Terminal cleared</div>';
            terminalBuffer = [];
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            pauseBtn.textContent = autoScroll ? 'Pause Auto-Scroll' : 'Resume Auto-Scroll';
            if (autoScroll) {
                terminal.scrollTop = terminal.scrollHeight;
            }
        }

        function downloadLog() {
            const logText = terminalBuffer.map(line => line.text).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `serial-log-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function rebuildTerminal() {
            terminal.innerHTML = '';
            terminalBuffer.forEach(line => {
                if (filters[line.type].checked) {
                    const lineEl = document.createElement('div');
                    lineEl.className = `terminal-line ${line.type}`;
                    lineEl.textContent = line.text;
                    terminal.appendChild(lineEl);
                }
            });
            if (autoScroll) {
                terminal.scrollTop = terminal.scrollHeight;
            }
        }

        // Event listeners
        document.getElementById('clear-terminal').addEventListener('click', clearTerminal);
        document.getElementById('pause-scroll').addEventListener('click', toggleAutoScroll);
        document.getElementById('download-log').addEventListener('click', downloadLog);

        // Filter change listeners
        Object.values(filters).forEach(checkbox => {
            checkbox.addEventListener('change', rebuildTerminal);
        });

        // Connect on load
        connectWebSocket();
    </script>
</body>
</html>
